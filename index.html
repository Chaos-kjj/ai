<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº·åº·èƒŒè¯å™¨ (æœ¬åœ°AIç‰ˆ)</title>
    <style>
        /* General Styling */
        *, *::before, *::after { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #f0f2f5; 
            color: #333; 
            margin: 0; 
            padding: 1rem; 
        }
        main { 
            text-align: center; 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto;
            position: relative;
        }

        .hidden { display: none !important; }
        #app-title { 
            font-size: 2.8rem; 
            font-weight: 300; 
            color: #555; 
            letter-spacing: 4px; 
            margin: 1rem 0 2rem 0; 
        }
        
        /* Add Word Container */
        #add-word-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 1.5rem; 
            background-color: #fff; 
            padding: 1rem; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
        }
        #add-word-input { 
            flex-grow: 1; 
            border: 1px solid #ccc; 
            padding: 0.75rem; 
            border-radius: 8px; 
            font-size: 1rem; 
        }
        #add-word-btn { 
            border: none; 
            background-color: #17a2b8; 
            color: white; 
            padding: 0 1.5rem; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1rem; 
            transition: background-color 0.2s; 
        }
        #add-word-btn:hover { background-color: #138496; }

        /* Mode Switcher */
        .mode-switcher { 
            margin-bottom: 1.5rem; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
        }
        .mode-button { 
            background: #fff; 
            border: 1px solid #ccc; 
            padding: 0.5rem 1rem; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            margin: 0; 
        }
        .mode-button.active { 
            background: #007bff; 
            color: white; 
            border-color: #007bff; 
        }

        /* Word Card */
        .word-card { 
            background-color: #ffffff; 
            padding: 2.5rem 2rem; 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
            min-height: 400px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
        }
        .word-header { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 1rem; 
            margin-bottom: 2rem; 
        }
        #main-word { 
            font-size: 3.5rem; 
            font-weight: bold; 
            margin: 0; 
        }
        #word-details { transition: opacity 0.5s ease; }
        #pronunciation, #definition { margin: 0.5rem 0; }
        .speak-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            padding: 0.5rem; 
            line-height: 1; 
            border-radius: 50%; 
            transition: background-color 0.2s; 
        }
        .speak-btn:hover { background-color: #f0f0f0; }
        .speak-btn svg { width: 28px; height: 28px; fill: #555; }

        /* Sentence Makers & Feedback */
        #sentence-maker, #challenge-sentence-maker, #translation-challenge-maker { margin-top: 1.5rem; }
        #sentence-input, #challenge-sentence-input, #translation-challenge-input { 
            width: 100%; 
            min-height: 100px; 
            padding: 0.5rem; 
            font-size: 1rem; 
            border-radius: 8px; 
            border: 1px solid #ccc; 
        }
        #ai-feedback, #challenge-ai-feedback, #translation-ai-feedback { 
            margin-top: 1.5rem; 
            padding: 1rem; 
            border-radius: 8px; 
            background-color: #e9ecef; 
            text-align: left;
        }

        /* Loading Spinners */
        #loading-spinner, #challenge-loading-spinner, #translation-loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Action Buttons */
        .actions { 
            margin-top: 2rem; 
            display: flex; 
            justify-content: space-around; 
        }
        .action-button { 
            width: 45%; 
            border: none; 
            padding: 1rem; 
            border-radius: 50px; 
            font-size: 1.2rem; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        #btn-unknown { background-color: #ffc107; }
        #btn-known, #btn-confirm-known { background-color: #28a745; color: white; }
        #btn-correction, #btn-submit-sentence, #btn-finish-learning, #btn-start-challenge, #btn-submit-challenge, #btn-next-challenge, #btn-start-translation-challenge, #btn-submit-translation, #btn-next-translation-challenge { 
            background-color: #007bff; 
            color: white; 
        }
        
        /* Challenge Views */
        #challenge-setup, #translation-challenge-setup { padding: 2rem; }
        #challenge-words-display { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 15px; 
            margin-bottom: 1.5rem; 
        }
        .challenge-word-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            background: #fff; 
            padding: 8px 15px; 
            border-radius: 20px; 
            border: 1px solid #ddd; 
        }
        .challenge-word-item label { font-size: 0.8rem; cursor: pointer; }

        #translation-chinese-sentence {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 2rem;
            padding: 1rem;
            border-left: 4px solid #28a745;
            background-color: #f8f9fa;
        }
        
        /* List Views */
        .list-view { padding: 1rem; }
        .word-list-container { margin-bottom: 2rem; }
        .word-list-container h3 { 
            color: #007bff; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 0.5rem; 
        }
        .word-list { list-style-type: none; padding: 0; }
        .word-list li { 
            background-color: #fff; 
            padding: 0.75rem 1rem; 
            margin-bottom: 0.5rem; 
            border-radius: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .delete-word-btn { 
            background-color: #dc3545; 
            color: white; 
            border: none; 
            padding: 0.3rem 0.6rem; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        
        /* Errata Styles */
        #errata-view { text-align: left; }
        .errata-group { 
            background: #fff; 
            padding: 1.5rem; 
            border-radius: 12px; 
            margin-bottom: 1.5rem; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
        }
        .errata-group-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 1rem; 
            margin-bottom: 1rem; 
        }
        .errata-group-header h3 { margin: 0; color: #007bff; }
        .delete-group-btn { 
            background-color: #dc3545; 
            color: white; 
            border: none; 
            padding: 0.5rem 1rem; 
            border-radius: 8px; 
            cursor: pointer; 
        }
        .add-word-to-group-form { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 1rem; 
        }
        .add-word-to-group-input { 
            flex-grow: 1; 
            border: 1px solid #ccc; 
            padding: 0.5rem; 
            border-radius: 8px; 
        }
        .add-word-to-group-btn { 
            border: none; 
            background-color: #28a745; 
            color: white; 
            padding: 0 1.5rem; 
            border-radius: 8px; 
            cursor: pointer; 
        }
        .errata-word-list { list-style-type: none; padding: 0; }
        .errata-word-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.5rem; 
            border-bottom: 1px solid #f0f0f0; 
        }
        #create-group-btn { 
            width: 100%; 
            padding: 1rem; 
            font-size: 1.2rem; 
            background-color: #17a2b8; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            margin-top: 1rem; 
        }
        #word-source-selector-container { 
            margin-bottom: 1rem; 
            background-color: #fff; 
            padding: 1rem; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
        }
        #word-source-selector { 
            width: 100%; 
            padding: 0.75rem; 
            border-radius: 8px; 
            border: 1px solid #ccc; 
            font-size: 1rem; 
        }

        /* --- NEW: Ollama AI Settings Styles --- */
        #ai-settings-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
        }
        #ai-settings-btn svg {
            width: 24px;
            height: 24px;
            fill: #6c757d;
        }
        #ai-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .modal-content h3 {
            margin-top: 0;
            color: #333;
        }
        .modal-content .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        .modal-content label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .modal-content input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
        }
        .modal-actions {
            text-align: right;
            margin-top: 1.5rem;
        }
        .modal-actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
        }
        #save-ai-settings-btn {
            background-color: #007bff;
            color: white;
        }
        #close-ai-settings-btn {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    
    <main>
        <!-- NEW: AI Settings Button -->
        <button id="ai-settings-btn" title="AI è®¾ç½®">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
        </button>

        <h1 id="app-title">åº·åº·èƒŒè¯å™¨</h1>
        <div id="add-word-container">
            <input type="text" id="add-word-input" placeholder="å‘ä¸»è¯åº“æ·»åŠ æ–°å•è¯...">
            <button id="add-word-btn">æ·»åŠ å¹¶å­¦ä¹ </button>
        </div>
        <div class="mode-switcher">
            <button id="mode-learn" class="mode-button active">å­¦ä¹ </button>
            <button id="mode-challenge" class="mode-button">é€ å¥å¤§æŒ‘æˆ˜</button>
            <button id="mode-translation-challenge" class="mode-button">ç¿»è¯‘å¤§æŒ‘æˆ˜ âœï¸</button>
            <button id="mode-errata" class="mode-button">é”™è¯æœ¬ç®¡ç†</button>
            <button id="mode-known-list" class="mode-button">å·²è®¤è¯†åˆ—è¡¨</button>
            <button id="mode-review-list" class="mode-button">å¾…å¤ä¹ åˆ—è¡¨</button>
        </div>

        <!-- Learn View -->
        <div id="learn-view">
            <div id="word-source-selector-container">
                <label for="word-source-selector">å½“å‰è¯åº“: </label>
                <select id="word-source-selector"></select>
            </div>
            <div class="word-card">
                <div class="word-header">
                    <h2 id="main-word">æ­£åœ¨åˆå§‹åŒ–...</h2>
                    <button id="speak-btn" class="speak-btn hidden" title="æœ—è¯»å•è¯">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                    </button>
                </div>
                <div id="word-details" class="hidden">
                    <p id="pronunciation"></p>
                    <p id="definition"></p>
                </div>
                <div id="sentence-maker" class="hidden">
                    <p><strong>è¯·å°è¯•ç”¨è¿™ä¸ªå•è¯é€ ä¸€ä¸ªå¥å­ï¼š</strong></p>
                    <textarea id="sentence-input" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„å¥å­..."></textarea>
                </div>
                <div id="loading-spinner" class="hidden"></div>
                <div id="ai-feedback" class="hidden"></div>
            </div>
            <div id="actions-initial" class="actions"> <button id="btn-unknown" class="action-button">ä¸è®¤è¯†</button> <button id="btn-known" class="action-button">è®¤è¯†</button> </div>
            <div id="actions-confirm" class="actions hidden"> <button id="btn-correction" class="action-button">ä¿®æ­£:ä¸è®¤è¯†</button> <button id="btn-confirm-known" class="action-button">ä¸‹ä¸€ä¸ª</button> </div>
            <div id="actions-sentence" class="actions hidden"> <button id="btn-submit-sentence" class="action-button" style="width: 95%;">æäº¤é€ å¥</button> </div>
            <div id="actions-finish" class="actions hidden"> <button id="btn-finish-learning" class="action-button" style="width: 95%;">å®Œæˆå­¦ä¹ </button> </div>
        </div>

        <!-- Sentence Challenge View -->
        <div id="challenge-view" class="hidden">
             <div class="word-card">
                <div id="challenge-setup">
                    <h3>é€ å¥å¤§æŒ‘æˆ˜</h3>
                    <p>é€‰æ‹©å•è¯æ•°é‡ï¼Œç”¨æ‰€æœ‰å‡ºç°çš„å•è¯é€ ä¸€ä¸ªå¥å­æˆ–æ®µè½ã€‚</p>
                    <div>
                        <label for="word-count-selector">å•è¯æ•°é‡: </label>
                        <select id="word-count-selector">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="actions">
                        <button id="btn-start-challenge" class="action-button" style="width: 95%;">å¼€å§‹æŒ‘æˆ˜</button>
                    </div>
                </div>
                <div id="challenge-area" class="hidden">
                    <div id="challenge-words-display"></div>
                    <div id="challenge-sentence-maker">
                        <textarea id="challenge-sentence-input" placeholder="ç”¨ä¸Šé¢çš„æ‰€æœ‰å•è¯é€ å¥..."></textarea>
                    </div>
                    <div id="challenge-loading-spinner" class="hidden"></div>
                    <div id="challenge-ai-feedback" class="hidden"></div>
                </div>
            </div>
            <div id="actions-challenge" class="actions hidden">
                <button id="btn-submit-challenge" class="action-button" style="width: 45%;">æäº¤æ‰¹æ”¹</button>
                <button id="btn-next-challenge" class="action-button" style="width: 45%;">ä¸‹ä¸€ä¸ªæŒ‘æˆ˜</button>
            </div>
        </div>

        <!-- Translation Challenge View -->
        <div id="translation-challenge-view" class="hidden">
            <div class="word-card">
                <div id="translation-challenge-setup">
                    <h3>ç¿»è¯‘å¤§æŒ‘æˆ˜ âœï¸</h3>
                    <p>è¾“å…¥ä¸€ä¸ªä¸­æ–‡ä¸»é¢˜ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆä¸€ä¸ªç›¸å…³çš„å¥å­ï¼Œè¯·å°†å®ƒç¿»è¯‘æˆè‹±æ–‡ã€‚</p>
                    <input type="text" id="translation-topic-input" placeholder="ä¾‹å¦‚ï¼šæ•£æ­¥åœ¨é›¨å" style="width: 100%; padding: 0.5rem; font-size: 1rem; margin-bottom: 1rem;">
                    <div class="actions">
                        <button id="btn-start-translation-challenge" class="action-button" style="width: 95%;">å¼€å§‹æŒ‘æˆ˜</button>
                    </div>
                </div>
                <div id="translation-challenge-area" class="hidden">
                    <p id="translation-chinese-sentence"></p>
                    <div id="translation-challenge-maker">
                        <textarea id="translation-challenge-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„è‹±æ–‡ç¿»è¯‘..."></textarea>
                    </div>
                    <div id="translation-loading-spinner" class="hidden"></div>
                    <div id="translation-ai-feedback" class="hidden"></div>
                </div>
            </div>
            <div id="actions-translation-challenge" class="actions hidden">
                <button id="btn-submit-translation" class="action-button" style="width: 45%;">æäº¤æ‰¹æ”¹</button>
                <button id="btn-next-translation-challenge" class="action-button" style="width: 45%;">ä¸‹ä¸€ä¸ªé¢˜ç›®</button>
            </div>
        </div>

        <!-- Errata View -->
        <div id="errata-view" class="list-view hidden">
            <div id="errata-groups-container"></div>
            <button id="create-group-btn">åˆ›å»ºæ–°åˆ†ç»„</button>
        </div>

        <!-- Known List View -->
        <div id="known-list-view" class="list-view hidden">
            <div class="word-list-container">
                <h3>å·²è®¤è¯†åˆ—è¡¨</h3>
                <ul id="known-words-list" class="word-list"></ul>
            </div>
        </div>

        <!-- Review List View -->
        <div id="review-list-view" class="list-view hidden">
            <div class="word-list-container">
                <h3>å¾…å¤ä¹ åˆ—è¡¨</h3>
                <ul id="review-words-list" class="word-list"></ul>
            </div>
        </div>
    </main>

    <!-- NEW: AI Settings Modal -->
    <div id="ai-settings-modal" class="hidden">
        <div class="modal-content">
            <h3>æœ¬åœ°AIè®¾ç½®</h3>
            <div class="form-group">
                <label for="ollama-url-input">Ollama API åœ°å€</label>
                <input type="text" id="ollama-url-input" placeholder="http://localhost:11434">
            </div>
            <div class="form-group">
                <label for="ollama-model-input">æ¨¡å‹åç§°</label>
                <input type="text" id="ollama-model-input" placeholder="ä¾‹å¦‚: llama3, qwen:7b">
            </div>
            <div class="modal-actions">
                <button id="close-ai-settings-btn">å…³é—­</button>
                <button id="save-ai-settings-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Configuration and Constants ---
        const WORD_LIST_URL = 'https://gist.githubusercontent.com/Chaos-kjj/fb6947acc8117866d7c62e79b9288f84/raw/b7a1147e0e15df9480cbe5c5e73c8ebc87d981ca/word_lists.json';
        const LOCAL_STORAGE_KEY_PREFIX = 'mySmartWordBook_';
        const LOCAL_STORAGE_KEY = `${LOCAL_STORAGE_KEY_PREFIX}è€ƒç ”æ ¸å¿ƒ`;
        const LOCAL_STORAGE_KEY_KNOWN = `${LOCAL_STORAGE_KEY_PREFIX}knownList`;
        const LOCAL_STORAGE_KEY_REVIEW = `${LOCAL_STORAGE_KEY_PREFIX}reviewList`;
        const LOCAL_STORAGE_KEY_ERRATA = `${LOCAL_STORAGE_KEY_PREFIX}errata`;
        // NEW: Local storage for AI settings
        const LOCAL_STORAGE_KEY_AI_CONFIG = `${LOCAL_STORAGE_KEY_PREFIX}aiConfig`;

        const SRS_INTERVALS_DAYS = [1, 2, 4, 8, 15, 30, 60];
        const NEW_WORDS_PER_SESSION = 5;

        // --- 2. Get Page Elements ---
        // (Existing element queries are the same)
        const addWordInput = document.getElementById('add-word-input');
        const addWordBtn = document.getElementById('add-word-btn');
        const mainWordEl = document.getElementById('main-word');
        const speakBtn = document.getElementById('speak-btn');
        const learnView = document.getElementById('learn-view');
        const wordDetailsEl = document.getElementById('word-details');
        const pronunciationEl = document.getElementById('pronunciation');
        const definitionEl = document.getElementById('definition');
        const sentenceMakerEl = document.getElementById('sentence-maker');
        const sentenceInputEl = document.getElementById('sentence-input');
        const loadingSpinner = document.getElementById('loading-spinner');
        const aiFeedbackEl = document.getElementById('ai-feedback');
        const actionsInitial = document.getElementById('actions-initial');
        const actionsConfirm = document.getElementById('actions-confirm');
        const actionsSentence = document.getElementById('actions-sentence');
        const actionsFinish = document.getElementById('actions-finish');
        const btnUnknown = document.getElementById('btn-unknown');
        const btnKnown = document.getElementById('btn-known');
        const btnCorrection = document.getElementById('btn-correction');
        const btnConfirmKnown = document.getElementById('btn-confirm-known');
        const btnSubmitSentence = document.getElementById('btn-submit-sentence');
        const btnFinishLearning = document.getElementById('btn-finish-learning');
        const modeLearnBtn = document.getElementById('mode-learn');
        const modeChallengeBtn = document.getElementById('mode-challenge');
        const challengeView = document.getElementById('challenge-view');
        const challengeSetup = document.getElementById('challenge-setup');
        const challengeArea = document.getElementById('challenge-area');
        const wordCountSelector = document.getElementById('word-count-selector');
        const btnStartChallenge = document.getElementById('btn-start-challenge');
        const challengeWordsDisplay = document.getElementById('challenge-words-display');
        const challengeSentenceInput = document.getElementById('challenge-sentence-input');
        const challengeLoadingSpinner = document.getElementById('challenge-loading-spinner');
        const challengeAiFeedback = document.getElementById('challenge-ai-feedback');
        const actionsChallenge = document.getElementById('actions-challenge');
        const btnSubmitChallenge = document.getElementById('btn-submit-challenge');
        const btnNextChallenge = document.getElementById('btn-next-challenge');
        const modeTranslationChallengeBtn = document.getElementById('mode-translation-challenge');
        const translationChallengeView = document.getElementById('translation-challenge-view');
        const translationChallengeSetup = document.getElementById('translation-challenge-setup');
        const translationTopicInput = document.getElementById('translation-topic-input');
        const btnStartTranslationChallenge = document.getElementById('btn-start-translation-challenge');
        const translationChallengeArea = document.getElementById('translation-challenge-area');
        const translationChineseSentenceEl = document.getElementById('translation-chinese-sentence');
        const translationChallengeInput = document.getElementById('translation-challenge-input');
        const translationLoadingSpinner = document.getElementById('translation-loading-spinner');
        const translationAiFeedback = document.getElementById('translation-ai-feedback');
        const actionsTranslationChallenge = document.getElementById('actions-translation-challenge');
        const btnSubmitTranslation = document.getElementById('btn-submit-translation');
        const btnNextTranslationChallenge = document.getElementById('btn-next-translation-challenge');
        const modeKnownListBtn = document.getElementById('mode-known-list');
        const modeReviewListBtn = document.getElementById('mode-review-list');
        const knownListView = document.getElementById('known-list-view');
        const reviewListView = document.getElementById('review-list-view');
        const knownWordsListEl = document.getElementById('known-words-list');
        const reviewWordsListEl = document.getElementById('review-words-list');
        const modeErrataBtn = document.getElementById('mode-errata');
        const errataView = document.getElementById('errata-view');
        const errataGroupsContainer = document.getElementById('errata-groups-container');
        const createGroupBtn = document.getElementById('create-group-btn');
        const wordSourceSelector = document.getElementById('word-source-selector');

        // NEW: AI Settings Elements
        const aiSettingsBtn = document.getElementById('ai-settings-btn');
        const aiSettingsModal = document.getElementById('ai-settings-modal');
        const ollamaUrlInput = document.getElementById('ollama-url-input');
        const ollamaModelInput = document.getElementById('ollama-model-input');
        const saveAiSettingsBtn = document.getElementById('save-ai-settings-btn');
        const closeAiSettingsBtn = document.getElementById('close-ai-settings-btn');


        // --- 3. State Management ---
        let allWords = [];
        let learningQueue = [];
        let currentWord = null;
        let challengeWords = [];
        let currentChineseSentence = '';
        let knownWords = [];
        let reviewWords = [];
        let errata = {};
        // NEW: AI Config State
        let aiConfig = {
            url: 'http://localhost:11434',
            model: 'llama3'
        };

        function loadState() {
            allWords = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            knownWords = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_KNOWN) || '[]');
            reviewWords = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_REVIEW) || '[]');
            errata = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_ERRATA) || '{}');
            // NEW: Load AI Config
            const savedAiConfig = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_AI_CONFIG) || '{}');
            aiConfig = { ...aiConfig, ...savedAiConfig };
        }
        function saveState() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allWords));
            localStorage.setItem(LOCAL_STORAGE_KEY_KNOWN, JSON.stringify(knownWords));
            localStorage.setItem(LOCAL_STORAGE_KEY_REVIEW, JSON.stringify(reviewWords));
            localStorage.setItem(LOCAL_STORAGE_KEY_ERRATA, JSON.stringify(errata));
            // NEW: AI Config is saved separately by its own function
        }
        // NEW: Function to save AI config
        function saveAiConfig() {
            localStorage.setItem(LOCAL_STORAGE_KEY_AI_CONFIG, JSON.stringify(aiConfig));
        }
        
        // --- 4. UI State Machine and View Switching ---
        // (This section is unchanged)
        function updateUiForState(state) {
            wordDetailsEl.classList.add('hidden');
            sentenceMakerEl.classList.add('hidden');
            aiFeedbackEl.classList.add('hidden');
            actionsInitial.classList.add('hidden');
            actionsConfirm.classList.add('hidden');
            actionsSentence.classList.add('hidden');
            actionsFinish.classList.add('hidden');
            switch (state) {
                case 'reveal_word':
                    actionsInitial.classList.remove('hidden');
                    break;
                case 'show_answer':
                    wordDetailsEl.classList.remove('hidden');
                    actionsConfirm.classList.remove('hidden');
                    break;
                case 'make_sentence':
                    wordDetailsEl.classList.remove('hidden');
                    sentenceMakerEl.classList.remove('hidden');
                    sentenceInputEl.value = '';
                    actionsSentence.classList.remove('hidden');
                    break;
                case 'show_feedback':
                    wordDetailsEl.classList.remove('hidden');
                    sentenceMakerEl.classList.remove('hidden');
                    aiFeedbackEl.classList.remove('hidden');
                    actionsFinish.classList.remove('hidden');
                    break;
            }
        }
        function switchView(mode) {
            learnView.classList.add('hidden');
            challengeView.classList.add('hidden');
            translationChallengeView.classList.add('hidden');
            knownListView.classList.add('hidden');
            reviewListView.classList.add('hidden');
            errataView.classList.add('hidden');
            
            document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));

            if(mode === 'learn') {
                learnView.classList.remove('hidden');
                modeLearnBtn.classList.add('active');
            } else if (mode === 'challenge') {
                challengeView.classList.remove('hidden');
                modeChallengeBtn.classList.add('active');
            } else if (mode === 'translation-challenge') {
                translationChallengeView.classList.remove('hidden');
                modeTranslationChallengeBtn.classList.add('active');
            } else if (mode === 'known-list') {
                knownListView.classList.remove('hidden');
                modeKnownListBtn.classList.add('active');
                populateKnownList();
            } else if (mode === 'review-list') {
                reviewListView.classList.remove('hidden');
                modeReviewListBtn.classList.add('active');
                populateReviewList();
            } else if (mode === 'errata') { 
                errataView.classList.remove('hidden');
                modeErrataBtn.classList.add('active');
                renderErrataView();
            }
        }
        function populateKnownList() {
            knownWordsListEl.innerHTML = '';
            knownWords.forEach(word => {
                const li = document.createElement('li');
                li.textContent = word;
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.className = 'delete-word-btn';
                deleteBtn.onclick = () => handleDeleteWord(word, 'known');
                li.appendChild(deleteBtn);
                knownWordsListEl.appendChild(li);
            });
        }
        function populateReviewList() {
            reviewWordsListEl.innerHTML = '';
            reviewWords.forEach(word => {
                const li = document.createElement('li');
                li.textContent = word;
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.className = 'delete-word-btn';
                deleteBtn.onclick = () => handleDeleteWord(word, 'review');
                li.appendChild(deleteBtn);
                reviewWordsListEl.appendChild(li);
            });
        }
        function renderErrataView() {
            errataGroupsContainer.innerHTML = '';
            if (Object.keys(errata).length === 0) {
                errataGroupsContainer.innerHTML = '<p>è¿˜æ²¡æœ‰é”™è¯åˆ†ç»„ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºä¸€ä¸ªå§ï¼</p>';
            }
            for (const groupName in errata) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'errata-group';
                
                const header = document.createElement('div');
                header.className = 'errata-group-header';
                const title = document.createElement('h3');
                title.textContent = groupName;
                const deleteGroupBtn = document.createElement('button');
                deleteGroupBtn.textContent = 'åˆ é™¤åˆ†ç»„';
                deleteGroupBtn.className = 'delete-group-btn';
                deleteGroupBtn.onclick = () => handleDeleteGroup(groupName);
                header.appendChild(title);
                header.appendChild(deleteGroupBtn);
                
                const addForm = document.createElement('div');
                addForm.className = 'add-word-to-group-form';
                const addInput = document.createElement('input');
                addInput.type = 'text';
                addInput.placeholder = `å‘â€œ${groupName}â€æ·»åŠ å•è¯...`;
                addInput.className = 'add-word-to-group-input';
                const addBtn = document.createElement('button');
                addBtn.textContent = 'æ·»åŠ ';
                addBtn.className = 'add-word-to-group-btn';
                addBtn.onclick = () => {
                    handleAddWordToGroup(groupName, addInput.value);
                    addInput.value = '';
                };
                addForm.appendChild(addInput);
                addForm.appendChild(addBtn);

                const wordList = document.createElement('ul');
                wordList.className = 'errata-word-list';
                errata[groupName].forEach(word => {
                    const li = document.createElement('li');
                    li.textContent = word;
                    const deleteWordBtn = document.createElement('button');
                    deleteWordBtn.textContent = 'Ã—';
                    deleteWordBtn.className = 'delete-word-btn';
                    deleteWordBtn.title = 'ä»æœ¬åˆ†ç»„åˆ é™¤';
                    deleteWordBtn.onclick = () => handleDeleteWordFromGroup(groupName, word);
                    li.appendChild(deleteWordBtn);
                    wordList.appendChild(li);
                });

                groupDiv.appendChild(header);
                groupDiv.appendChild(addForm);
                groupDiv.appendChild(wordList);
                errataGroupsContainer.appendChild(groupDiv);
            }
            updateWordSourceSelector();
        }
        function handleCreateGroup() {
            const groupName = prompt('è¯·è¾“å…¥æ–°åˆ†ç»„çš„åç§°ï¼š');
            if (groupName && groupName.trim()) {
                if (errata[groupName.trim()]) {
                    alert('è¯¥åˆ†ç»„å·²å­˜åœ¨ï¼');
                } else {
                    errata[groupName.trim()] = [];
                    saveState();
                    renderErrataView();
                }
            }
        }
        function handleDeleteGroup(groupName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„â€œ${groupName}â€åŠå…¶ä¸­çš„æ‰€æœ‰å•è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                delete errata[groupName];
                saveState();
                renderErrataView();
            }
        }
        function handleAddWordToGroup(groupName, word) {
            const newWord = word.trim().toLowerCase();
            if (!newWord) {
                alert('è¯·è¾“å…¥ä¸€ä¸ªå•è¯ã€‚');
                return;
            }
            if (!errata[groupName].includes(newWord)) {
                errata[groupName].push(newWord);
                if (!allWords.some(w => w.word === newWord)) {
                    allWords.push({
                        word: newWord,
                        status: 'new',
                        srsLevel: 0,
                        nextReviewDate: null
                    });
                }
                saveState();
                renderErrataView();
            } else {
                alert(`å•è¯â€œ${newWord}â€å·²åœ¨è¯¥åˆ†ç»„ä¸­ã€‚`);
            }
        }
        function handleDeleteWordFromGroup(groupName, word) {
            const wordIndex = errata[groupName].indexOf(word);
            if (wordIndex > -1) {
                errata[groupName].splice(wordIndex, 1);
                saveState();
                renderErrataView();
            }
        }
        function updateWordSourceSelector() {
            const selectedValue = wordSourceSelector.value;
            wordSourceSelector.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = 'default';
            defaultOption.textContent = 'é»˜è®¤è¯åº“ (è€ƒç ”æ ¸å¿ƒ)';
            wordSourceSelector.appendChild(defaultOption);
            if (Object.keys(errata).length > 0) {
                const allErrataOption = document.createElement('option');
                allErrataOption.value = 'errata_all';
                allErrataOption.textContent = 'æ‰€æœ‰é”™è¯';
                wordSourceSelector.appendChild(allErrataOption);
                const divider = document.createElement('option');
                divider.disabled = true;
                divider.textContent = '--- é”™è¯åˆ†ç»„ ---';
                wordSourceSelector.appendChild(divider);
                for (const groupName in errata) {
                    const groupOption = document.createElement('option');
                    groupOption.value = `errata_${groupName}`;
                    groupOption.textContent = `é”™è¯æœ¬: ${groupName}`;
                    wordSourceSelector.appendChild(groupOption);
                }
            }
            wordSourceSelector.value = selectedValue || 'default';
        }
        function addToList(listName, word) {
            let list, otherList;
            if (listName === 'known') {
                list = knownWords;
                otherList = reviewWords;
            } else if (listName === 'review') {
                list = reviewWords;
                otherList = knownWords;
            } else { return; }
            if (!list.includes(word)) { list.push(word); }
            const otherIndex = otherList.indexOf(word);
            if (otherIndex > -1) { otherList.splice(otherIndex, 1); }
            saveState();
        }

        // --- 5. Core Learning Logic ---
        // (This section is mostly unchanged, logic for queue building remains the same)
        function speakWord(text) { if ('speechSynthesis' in window && text) { window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'en-US'; utterance.rate = 0.9; window.speechSynthesis.speak(utterance); } }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } }
        function buildLearningQueue() {
            const source = wordSourceSelector.value;
            let sourceWords = [];
            if (source.startsWith('errata_')) {
                const groupName = source.replace('errata_', '');
                if (groupName === 'all') {
                    const allErrataWords = new Set();
                    Object.values(errata).forEach(group => {
                        group.forEach(word => allErrataWords.add(word));
                    });
                    sourceWords = Array.from(allErrataWords);
                } else if (errata[groupName]) {
                    sourceWords = errata[groupName];
                }
            }
            let wordObjectsToLearn;
            if (sourceWords.length > 0) {
                 wordObjectsToLearn = allWords.filter(w => sourceWords.includes(w.word));
            } else {
                const today = new Date().setHours(0, 0, 0, 0);
                const wordsToReview = allWords.filter(word => word.status === 'learning' && new Date(word.nextReviewDate).setHours(0,0,0,0) <= today);
                const newWords = allWords.filter(word => word.status === 'new');
                shuffleArray(wordsToReview);
                shuffleArray(newWords);
                wordObjectsToLearn = [...wordsToReview];
                if (wordsToReview.length === 0 && newWords.length > 0) {
                    wordObjectsToLearn = newWords.slice(0, NEW_WORDS_PER_SESSION);
                }
            }
            shuffleArray(wordObjectsToLearn);
            learningQueue = wordObjectsToLearn;
        }
        function showNextWord() { 
            buildLearningQueue(); 
            if (learningQueue.length > 0) {
                currentWord = learningQueue.shift();
                mainWordEl.textContent = currentWord.word;
                updateUiForState('reveal_word');
                speakBtn.classList.remove('hidden');
            } else {
                const sourceName = wordSourceSelector.options[wordSourceSelector.selectedIndex].text;
                learnView.innerHTML = `<div id="word-source-selector-container" style="margin-bottom: 1rem;"><label for="word-source-selector">å½“å‰è¯åº“: </label><select id="word-source-selector"></select></div><div class="word-card" style="font-size: 1.5rem; color: #007bff;">è¯åº“â€œ${sourceName}â€æœ¬æ—¥ä»»åŠ¡å®Œæˆï¼ğŸ‰</div>`;
                const newSelector = document.getElementById('word-source-selector');
                newSelector.onchange = () => { window.location.reload(); }; 
                updateWordSourceSelector();
                speakBtn.classList.add('hidden');
            }
        }
        
        // This function remains, as it uses the Youdao API which was requested to be kept.
        async function loadWordDetails() {
             pronunciationEl.textContent = '...';
             definitionEl.textContent = 'æ­£åœ¨è·å–ä¸­æ–‡é‡Šä¹‰...';
             try {
                 const response = await fetch('/api/get-definition', { 
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ word: currentWord.word })
                 });
                 if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.error || 'è·å–é‡Šä¹‰å¤±è´¥');
                 }
                 const data = await response.json();
                 pronunciationEl.textContent = data.pronunciation || '';
                 definitionEl.textContent = data.definition || 'æ— å¯ç”¨é‡Šä¹‰';
             } catch (error) {
                 console.error("åŠ è½½å•è¯è¯¦æƒ…å¤±è´¥:", error);
                 pronunciationEl.textContent = `[${currentWord.word}]`;
                 definitionEl.textContent = `é‡Šä¹‰åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœ¬åœ°æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚`;
             }
        }

        function startNewChallenge() { 
            const wordCount = parseInt(wordCountSelector.value); 
            const availableWords = allWords.filter(w => w.status !== 'known'); 
            if (availableWords.length < wordCount) { alert(`è¯åº“ä¸­å¯ä¾›æŒ‘æˆ˜çš„å•è¯ä¸è¶³${wordCount}ä¸ªï¼`); return; } 
            shuffleArray(availableWords); 
            challengeWords = availableWords.slice(0, wordCount).map(w => w.word); 
            challengeWordsDisplay.innerHTML = ''; 
            challengeWords.forEach(word => { 
                const itemDiv = document.createElement('div'); 
                itemDiv.className = 'challenge-word-item'; 
                const wordSpan = document.createElement('span'); 
                wordSpan.textContent = word; 
                const checkboxLabel = document.createElement('label'); 
                const checkbox = document.createElement('input'); 
                checkbox.type = 'checkbox'; 
                checkbox.dataset.word = word; 
                checkboxLabel.appendChild(checkbox); 
                checkboxLabel.append(' ä¸è®¤è¯†'); 
                itemDiv.appendChild(wordSpan); 
                itemDiv.appendChild(checkboxLabel); 
                challengeWordsDisplay.appendChild(itemDiv); 
            }); 
            challengeSetup.classList.add('hidden'); 
            challengeArea.classList.remove('hidden'); 
            challengeSentenceInput.value = ''; 
            challengeAiFeedback.classList.add('hidden'); 
            actionsChallenge.classList.remove('hidden'); 
            btnSubmitChallenge.classList.remove('hidden'); 
            btnNextChallenge.classList.add('hidden'); 
        }
        
        // --- 6. Connect to Local AI ---
        // NEW: All AI functions now call our local server, passing the AI config.

        async function startNewTranslationChallenge() {
            const topic = translationTopicInput.value.trim();
            if (!topic) { alert('è¯·è¾“å…¥ä¸€ä¸ªä¸­æ–‡ä¸»é¢˜ï¼'); return; }
            translationChallengeSetup.classList.add('hidden');
            translationChallengeArea.classList.remove('hidden');
            translationAiFeedback.classList.add('hidden');
            actionsTranslationChallenge.classList.remove('hidden');
            btnSubmitTranslation.classList.remove('hidden');
            btnNextTranslationChallenge.classList.add('hidden');
            translationChallengeInput.value = '';
            translationLoadingSpinner.classList.remove('hidden');
            translationChineseSentenceEl.textContent = 'æœ¬åœ°AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸­æ–‡å¥å­...';
            try {
                const response = await fetch('/api/get-translation-challenge', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, aiConfig }) // Pass AI config
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.details || 'è·å–ä¸­æ–‡å¥å­å¤±è´¥');
                }
                const data = await response.json();
                currentChineseSentence = data.chinese_sentence;
                translationChineseSentenceEl.textContent = currentChineseSentence;
            } catch (error) {
                translationChineseSentenceEl.textContent = `âŒ è·å–å¥å­å¤±è´¥: ${error.message}. è¯·æ£€æŸ¥æœ¬åœ°æœåŠ¡å™¨å’ŒOllamaæ˜¯å¦æ­£åœ¨è¿è¡Œã€‚`;
            } finally {
                translationLoadingSpinner.classList.add('hidden');
            }
        }

        async function getRealAiSentenceCheck(words, sentence) {
            try {
                const response = await fetch('/api/check-sentence', { 
                    method: 'POST',
                    headers: {'Content-Type': 'application/json',},
                    body: JSON.stringify({ words, sentence, aiConfig }), // Pass AI config
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || 'AIæœåŠ¡å™¨è¿”å›é”™è¯¯');
                }
                const data = await response.json();
                let feedbackHTML = `<p><strong>AIè€å¸ˆç‚¹è¯„ï¼š</strong></p><p>${data.explanation}</p><p><strong>å‚è€ƒä¾‹å¥ï¼š</strong> ${data.correct_example}</p>`;
                return feedbackHTML;
            } catch (error) {
                console.error("è¿æ¥æœ¬åœ°AIå¤±è´¥:", error);
                return `âŒ è¿æ¥æœ¬åœ°AIæ—¶å‡ºé”™: ${error.message}ã€‚è¯·æ£€æŸ¥æœ¬åœ°æœåŠ¡å™¨å’ŒOllamaæ˜¯å¦æ­£åœ¨è¿è¡Œã€‚`;
            }
        }
        async function getRealAiTranslationCheck(original, translation) {
            try {
                const response = await fetch('/api/check-translation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ original_chinese: original, user_translation: translation, aiConfig }) // Pass AI config
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || 'AIæœåŠ¡å™¨è¿”å›é”™è¯¯');
                }
                const data = await response.json();
                let feedbackHTML = `<p><strong>AIè€å¸ˆç‚¹è¯„ï¼š</strong></p><p>${data.explanation}</p><p><strong>å‚è€ƒç¿»è¯‘ï¼š</strong> ${data.better_translation}</p>`;
                return feedbackHTML;
            } catch (error) {
                console.error("è¿æ¥ç¿»è¯‘æ‰¹æ”¹AIå¤±è´¥:", error);
                return `âŒ è¯·æ±‚AIæ‰¹æ”¹æ—¶å‡ºé”™: ${error.message}ã€‚è¯·æ£€æŸ¥æœ¬åœ°æœåŠ¡å™¨å’ŒOllamaæ˜¯å¦æ­£åœ¨è¿è¡Œã€‚`;
            }
        }


        // --- 7. Event Handlers ---
        // (This section has minor changes to call the new AI functions)
        function handleDeleteWord(word, listName) {
            if (listName === 'known') {
                knownWords = knownWords.filter(w => w !== word);
                populateKnownList();
            } else if (listName === 'review') {
                reviewWords = reviewWords.filter(w => w !== word);
                populateReviewList();
            }
            saveState();
        }
        function handleAddWordClick() {
            const newWordStr = addWordInput.value.trim().toLowerCase();
            if (!newWordStr) { alert('è¯·è¾“å…¥ä¸€ä¸ªå•è¯ã€‚'); return; }
            if (allWords.some(w => w.word === newWordStr)) { alert(`å•è¯ "${newWordStr}" å·²å­˜åœ¨äºæ‚¨çš„ä¸»è¯åº“ä¸­ã€‚`); return; }
            const newWordObj = { word: newWordStr, status: 'learning', srsLevel: 0, nextReviewDate: new Date().toISOString() };
            allWords.push(newWordObj);
            addToList('review', newWordStr);
            saveState();
            addWordInput.value = '';
            alert(`å•è¯ "${newWordStr}" å·²æˆåŠŸæ·»åŠ åˆ°ä¸»è¯åº“å’Œå¾…å¤ä¹ åˆ—è¡¨ï¼`);
            showNextWord(); 
        }
        speakBtn.addEventListener('click', () => { if (currentWord) { speakWord(currentWord.word); } });
        addWordBtn.addEventListener('click', handleAddWordClick);
        btnKnown.addEventListener('click', () => {
            const wordIndex = allWords.findIndex(w => w.word === currentWord.word);
            if (wordIndex > -1) {
                allWords[wordIndex].status = 'known';
                allWords[wordIndex].srsLevel = -1;
                allWords[wordIndex].nextReviewDate = null;
                addToList('known', currentWord.word);
            }
            updateUiForState('show_answer');
            loadWordDetails();
        });
        btnUnknown.addEventListener('click', () => {
            const wordIndex = allWords.findIndex(w => w.word === currentWord.word);
            if (wordIndex > -1) {
                allWords[wordIndex].status = 'learning';
                allWords[wordIndex].srsLevel = 0;
                const nextReviewDate = new Date();
                nextReviewDate.setDate(nextReviewDate.getDate() + SRS_INTERVALS_DAYS[0]);
                allWords[wordIndex].nextReviewDate = nextReviewDate.toISOString();
                addToList('review', currentWord.word);
            }
            updateUiForState('make_sentence');
            loadWordDetails();
        });
        btnConfirmKnown.addEventListener('click', () => { saveState(); showNextWord(); });
        btnCorrection.addEventListener('click', () => { 
            const wordIndex = allWords.findIndex(w => w.word === currentWord.word);
             if (wordIndex > -1) {
                allWords[wordIndex].status = 'learning';
                allWords[wordIndex].srsLevel = 0;
                const nextReviewDate = new Date();
                nextReviewDate.setDate(nextReviewDate.getDate() + SRS_INTERVALS_DAYS[0]);
                allWords[wordIndex].nextReviewDate = nextReviewDate.toISOString();
                addToList('review', currentWord.word);
            }
            updateUiForState('make_sentence'); 
        });
        btnSubmitSentence.addEventListener('click', async () => { 
            const userSentence = sentenceInputEl.value.trim();
            if (userSentence) {
                loadingSpinner.classList.remove('hidden');
                aiFeedbackEl.classList.add('hidden');
                let feedback = '';
                try {
                    feedback = await getRealAiSentenceCheck([currentWord.word], userSentence);
                } catch (e) {
                    feedback = `âŒ è¯·æ±‚AIæ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: ${e.message}`;
                } finally {
                    loadingSpinner.classList.add('hidden');
                    aiFeedbackEl.innerHTML = feedback;
                    updateUiForState('show_feedback');
                }
            } else {
                alert("è¯·è¾“å…¥ä¸€ä¸ªå¥å­ï¼");
            } 
        });
        btnFinishLearning.addEventListener('click', () => {
            const wordIndex = allWords.findIndex(w => w.word === currentWord.word);
            if (wordIndex > -1) {
                allWords[wordIndex].status = 'learning'; 
                let currentLevel = allWords[wordIndex].srsLevel;
                if (currentLevel < SRS_INTERVALS_DAYS.length - 1) { allWords[wordIndex].srsLevel++; }
                const interval = SRS_INTERVALS_DAYS[allWords[wordIndex].srsLevel];
                const nextReviewDate = new Date();
                nextReviewDate.setDate(nextReviewDate.getDate() + interval);
                allWords[wordIndex].nextReviewDate = nextReviewDate.toISOString();
            }
            saveState();
            showNextWord();
        });
        btnStartChallenge.addEventListener('click', startNewChallenge);
        btnNextChallenge.addEventListener('click', startNewChallenge);
        btnSubmitChallenge.addEventListener('click', async () => {
            const userSentence = challengeSentenceInput.value.trim();
            if (!userSentence) { alert('è¯·è¾“å…¥æ‚¨çš„å¥å­ï¼'); return; }
            const unknownWordsCheckboxes = challengeWordsDisplay.querySelectorAll('input[type="checkbox"]:checked');
            unknownWordsCheckboxes.forEach(checkbox => {
                const wordToMark = checkbox.dataset.word;
                const wordIndex = allWords.findIndex(w => w.word === wordToMark);
                if (wordIndex > -1) {
                    const wordObj = allWords[wordIndex];
                    wordObj.status = 'learning';
                    wordObj.srsLevel = 0;
                    const nextReviewDate = new Date();
                    nextReviewDate.setDate(nextReviewDate.getDate() + SRS_INTERVALS_DAYS[0]);
                    wordObj.nextReviewDate = nextReviewDate.toISOString();
                    addToList('review', wordToMark);
                }
            });
            saveState();
            challengeAiFeedback.classList.add('hidden');
            challengeLoadingSpinner.classList.remove('hidden');
            let feedback = '';
            try {
                feedback = await getRealAiSentenceCheck(challengeWords, userSentence);
            } catch (e) {
                feedback = `âŒ è¯·æ±‚AIæ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: ${e.message}`;
            } finally {
                challengeLoadingSpinner.classList.add('hidden');
                challengeAiFeedback.innerHTML = feedback;
                challengeAiFeedback.classList.remove('hidden');
                btnSubmitChallenge.classList.add('hidden');
                btnNextChallenge.classList.remove('hidden');
            }
        });
        modeLearnBtn.addEventListener('click', () => switchView('learn'));
        modeChallengeBtn.addEventListener('click', () => switchView('challenge'));
        modeTranslationChallengeBtn.addEventListener('click', () => switchView('translation-challenge'));
        modeKnownListBtn.addEventListener('click', () => switchView('known-list'));
        modeReviewListBtn.addEventListener('click', () => switchView('review-list'));
        modeErrataBtn.addEventListener('click', () => switchView('errata'));
        createGroupBtn.addEventListener('click', handleCreateGroup);
        wordSourceSelector.addEventListener('change', showNextWord);
        btnStartTranslationChallenge.addEventListener('click', startNewTranslationChallenge);
        btnNextTranslationChallenge.addEventListener('click', () => {
            translationChallengeSetup.classList.remove('hidden');
            translationChallengeArea.classList.add('hidden');
            actionsTranslationChallenge.classList.add('hidden');
        });
        btnSubmitTranslation.addEventListener('click', async () => {
            const userTranslation = translationChallengeInput.value.trim();
            if (!userTranslation) { alert('è¯·è¾“å…¥æ‚¨çš„ç¿»è¯‘ï¼'); return; }
            translationAiFeedback.classList.add('hidden');
            translationLoadingSpinner.classList.remove('hidden');
            let feedback = '';
            try {
                feedback = await getRealAiTranslationCheck(currentChineseSentence, userTranslation);
            } catch (e) {
                feedback = `âŒ è¯·æ±‚AIæ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: ${e.message}`;
            } finally {
                translationLoadingSpinner.classList.add('hidden');
                translationAiFeedback.innerHTML = feedback;
                translationAiFeedback.classList.remove('hidden');
                btnSubmitTranslation.classList.add('hidden');
                btnNextTranslationChallenge.classList.remove('hidden');
            }
        });

        // NEW: AI Settings Modal Handlers
        aiSettingsBtn.addEventListener('click', () => {
            ollamaUrlInput.value = aiConfig.url;
            ollamaModelInput.value = aiConfig.model;
            aiSettingsModal.classList.remove('hidden');
        });
        closeAiSettingsBtn.addEventListener('click', () => {
            aiSettingsModal.classList.add('hidden');
        });
        saveAiSettingsBtn.addEventListener('click', () => {
            aiConfig.url = ollamaUrlInput.value.trim() || 'http://localhost:11434';
            aiConfig.model = ollamaModelInput.value.trim() || 'llama3';
            saveAiConfig();
            aiSettingsModal.classList.add('hidden');
            alert('AIè®¾ç½®å·²ä¿å­˜ï¼');
        });

        // --- 8. Initialize Application ---
        async function initializeApp() {
            loadState();
            if (allWords.length === 0) {
                mainWordEl.textContent = "é¦–æ¬¡åŠ è½½ï¼Œæ­£åœ¨åŒæ­¥äº‘ç«¯è¯åº“...";
                try {
                    const response = await fetch(WORD_LIST_URL);
                    if (!response.ok) throw new Error('æ— æ³•è·å–äº‘ç«¯è¯åº“');
                    const wordList = await response.json();
                    let initialWords = [];
                    if (Array.isArray(wordList)) {
                       initialWords = wordList;
                    } else {
                       const firstListName = Object.keys(wordList)[0];
                       initialWords = firstListName ? wordList[firstListName] : [];
                    }
                    if (initialWords.length === 0) throw new Error('äº‘ç«¯è¯åº“ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                    allWords = initialWords.map(word => ({ word: String(word).toLowerCase(), status: 'new', srsLevel: 0, nextReviewDate: null }));
                    saveState();
                } catch (error) {
                    learnView.innerHTML = `<div class="word-card">åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
                    return;
                }
            }
            updateWordSourceSelector();
            switchView('learn');
            showNextWord();
        }

        initializeApp();
    </script>
</body>
</html>
