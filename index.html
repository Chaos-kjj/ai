<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å•è¯æœ¬ - è¿æ¥çœŸå®AI</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 1rem; }
        main { text-align: center; width: 100%; max-width: 600px; margin: 0 auto;}

        /* --- æ ·å¼éƒ¨åˆ† --- */
        .hidden { display: none !important; }

        .word-card { background-color: #ffffff; padding: 2.5rem 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); min-height: 400px; display: flex; flex-direction: column; justify-content: center; }
        #word-details { transition: opacity 0.5s ease; }
        #main-word { font-size: 3.5rem; font-weight: bold; margin-bottom: 2rem; }
        #pronunciation, #definition { margin: 0.5rem 0; }
        
        #sentence-maker { margin-top: 1.5rem; }
        #sentence-input { width: 100%; min-height: 80px; padding: 0.5rem; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; }
        #ai-feedback { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; background-color: #e9ecef; text-align: left;}

        .actions { margin-top: 2rem; display: flex; justify-content: space-around; }
        .action-button { width: 45%; border: none; padding: 1rem; border-radius: 50px; font-size: 1.2rem; cursor: pointer; transition: all 0.2s ease; }
        #btn-unknown { background-color: #ffc107; }
        #btn-known, #btn-confirm-known { background-color: #28a745; color: white; }
        #btn-correction, #btn-submit-sentence, #btn-finish-learning { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    
    <main>
        <div id="learn-view">
            <div class="word-card">
                <h2 id="main-word">æ­£åœ¨åˆå§‹åŒ–...</h2>
                
                <!-- å•è¯è¯¦æƒ…ï¼Œåˆå§‹å¯éšè— -->
                <div id="word-details" class="hidden">
                    <p id="pronunciation"></p>
                    <p id="definition"></p>
                </div>

                <!-- é€ å¥æ¨¡å—ï¼Œé»˜è®¤éšè— -->
                <div id="sentence-maker" class="hidden">
                    <p><strong>è¯·å°è¯•ç”¨è¿™ä¸ªå•è¯é€ ä¸€ä¸ªå¥å­ï¼š</strong></p>
                    <textarea id="sentence-input" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„å¥å­..."></textarea>
                </div>
                
                <!-- AIåé¦ˆæ¨¡å—ï¼Œé»˜è®¤éšè— -->
                <div id="ai-feedback" class="hidden"></div>
            </div>

            <!-- æŒ‰é’®åŒºï¼Œä¼šæ ¹æ®ä¸åŒçŠ¶æ€åˆ‡æ¢ -->
            <div id="actions-initial" class="actions">
                <button id="btn-unknown" class="action-button">ä¸è®¤è¯†</button>
                <button id="btn-known" class="action-button">è®¤è¯†</button>
            </div>
            <div id="actions-confirm" class="actions hidden">
                <button id="btn-correction" class="action-button">ä¿®æ­£:ä¸è®¤è¯†</button>
                <button id="btn-confirm-known" class="action-button">ä¸‹ä¸€ä¸ª</button>
            </div>
            <div id="actions-sentence" class="actions hidden">
                <button id="btn-submit-sentence" class="action-button" style="width: 95%;">æäº¤é€ å¥</button>
            </div>
            <div id="actions-finish" class="actions hidden">
                <button id="btn-finish-learning" class="action-button" style="width: 95%;">å®Œæˆå­¦ä¹ </button>
            </div>
        </div>
    </main>

    <script>
        // --- 1. é…ç½®å’Œå¸¸é‡ ---
        const WORD_LIST_URL = 'https://gist.githubusercontent.com/Chaos-kjj/fb6947acc8117866d7c62e79b9288f84/raw/b7a1147e0e15df9480cbe5c5e73c8ebc87d981ca/word_lists.json';
        const LOCAL_STORAGE_KEY = 'mySmartWordBook';
        const SRS_INTERVALS_DAYS = [1, 2, 4, 8, 15, 30, 60];
        const NEW_WORDS_PER_SESSION = 5;

        // --- 2. è·å–é¡µé¢å…ƒç´  ---
        const mainWordEl = document.getElementById('main-word');
        const wordDetailsEl = document.getElementById('word-details');
        const pronunciationEl = document.getElementById('pronunciation');
        const definitionEl = document.getElementById('definition');
        
        const sentenceMakerEl = document.getElementById('sentence-maker');
        const sentenceInputEl = document.getElementById('sentence-input');
        const aiFeedbackEl = document.getElementById('ai-feedback');

        const actionsInitial = document.getElementById('actions-initial');
        const actionsConfirm = document.getElementById('actions-confirm');
        const actionsSentence = document.getElementById('actions-sentence');
        const actionsFinish = document.getElementById('actions-finish');

        const btnUnknown = document.getElementById('btn-unknown');
        const btnKnown = document.getElementById('btn-known');
        const btnCorrection = document.getElementById('btn-correction');
        const btnConfirmKnown = document.getElementById('btn-confirm-known');
        const btnSubmitSentence = document.getElementById('btn-submit-sentence');
        const btnFinishLearning = document.getElementById('btn-finish-learning');

        // --- 3. çŠ¶æ€ç®¡ç† ---
        let allWords = [];
        let learningQueue = [];
        let currentWord = null;

        function loadState() { return localStorage.getItem(LOCAL_STORAGE_KEY) ? JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) : []; }
        function saveState() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allWords)); }
        
        // --- 4. UIçŠ¶æ€æœºï¼šæ ¹æ®ä¸åŒå­¦ä¹ é˜¶æ®µæ˜¾ç¤º/éšè—å…ƒç´  ---
        function updateUiForState(state) {
            wordDetailsEl.classList.add('hidden');
            sentenceMakerEl.classList.add('hidden');
            aiFeedbackEl.classList.add('hidden');
            actionsInitial.classList.add('hidden');
            actionsConfirm.classList.add('hidden');
            actionsSentence.classList.add('hidden');
            actionsFinish.classList.add('hidden');

            switch (state) {
                case 'reveal_word':
                    actionsInitial.classList.remove('hidden');
                    break;
                case 'show_answer':
                    wordDetailsEl.classList.remove('hidden');
                    actionsConfirm.classList.remove('hidden');
                    break;
                case 'make_sentence':
                    wordDetailsEl.classList.remove('hidden');
                    sentenceMakerEl.classList.remove('hidden');
                    sentenceInputEl.value = '';
                    actionsSentence.classList.remove('hidden');
                    break;
                case 'show_feedback':
                    wordDetailsEl.classList.remove('hidden');
                    sentenceMakerEl.classList.remove('hidden');
                    aiFeedbackEl.classList.remove('hidden');
                    actionsFinish.classList.remove('hidden');
                    break;
            }
        }

        // --- 5. æ ¸å¿ƒå­¦ä¹ é€»è¾‘ ---
        function buildLearningQueue() { const t=new Date().setHours(0,0,0,0),e=allWords.filter(e=>"learning"===e.status&&new Date(e.nextReviewDate).setHours(0,0,0,0)<=t),n=allWords.filter(e=>"new"===e.status);learningQueue=[...e],0===e.length&&(learningQueue=n.slice(0,NEW_WORDS_PER_SESSION))}

        function showNextWord() {
            buildLearningQueue();
            if (learningQueue.length > 0) {
                currentWord = learningQueue.shift();
                mainWordEl.textContent = currentWord.word;
                updateUiForState('reveal_word');
            } else {
                mainWordEl.textContent = 'ä»Šæ—¥ä»»åŠ¡å®Œæˆï¼ğŸ‰';
                actionsInitial.classList.add('hidden');
            }
        }
        
        async function loadWordDetails() {
            pronunciationEl.textContent = '...';
            definitionEl.textContent = 'æ­£åœ¨è·å–é‡Šä¹‰...';
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${currentWord.word}`);
                if (!response.ok) throw new Error('æ‰¾ä¸åˆ°å•è¯');
                const data = await response.json();
                pronunciationEl.textContent = data[0].phonetics.find(p=>p.text)?.text || '';
                definitionEl.textContent = data[0].meanings[0]?.definitions[0]?.definition || 'æ— å¯ç”¨é‡Šä¹‰';
            } catch (error) {
                definitionEl.textContent = 'é‡Šä¹‰åŠ è½½å¤±è´¥ã€‚';
            }
        }

        // =========================================================================
        // --- 6. (å·²æ›´æ–°) è¿æ¥çœŸå®AI ---
        // è¿™ä¸ªå‡½æ•°å°†ä»£æ›¿ä¹‹å‰çš„AIæ¨¡æ‹Ÿå™¨
        // =========================================================================
        async function getRealAiSentenceCheck(word, sentence) {
            aiFeedbackEl.innerHTML = "<em>AI è€å¸ˆæ­£åœ¨æ‰¹æ”¹... (è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)</em>";

            try {
                // è¿™ä¸ªç›¸å¯¹è·¯å¾„ '/api/check-sentence' ä¼šè¢«Vercelè‡ªåŠ¨æŒ‡å‘æˆ‘ä»¬éƒ¨ç½²çš„åç«¯å‡½æ•°ã€‚
                // åœ¨æœ¬åœ°æµ‹è¯•æ—¶å®ƒä¼šä¸å·¥ä½œï¼Œä½†ä¸€æ—¦éƒ¨ç½²åˆ°Vercelä¸Šï¼Œå®ƒå°±èƒ½ç¥å¥‡åœ°æ‰¾åˆ°æ­£ç¡®çš„è·¯å¾„ã€‚
                const response = await fetch('/api/check-sentence', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ word, sentence }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`AIæœåŠ¡å™¨è¿”å›é”™è¯¯: ${errorData.error || response.statusText}`);
                }

                // è§£æåç«¯è¿”å›çš„JSONæ•°æ®
                const data = await response.json(); 

                // å°†ç»“æ„åŒ–çš„åé¦ˆæ ¼å¼åŒ–æˆç”¨æˆ·å‹å¥½çš„HTML
                let feedbackHTML = `
                    <p><strong>AIè€å¸ˆç‚¹è¯„ï¼š</strong></p>
                    <p>${data.explanation}</p>
                    <p><strong>å‚è€ƒä¾‹å¥ï¼š</strong> ${data.correct_example}</p>
                `;
                return feedbackHTML;

            } catch (error) {
                console.error("è¿æ¥AIå¤±è´¥:", error);
                return `âŒ è¿æ¥AIæ—¶å‡ºé”™ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚<br>é”™è¯¯è¯¦æƒ…: ${error.message}`;
            }
        }

        // --- 7. äº‹ä»¶å¤„ç† ---

        btnKnown.addEventListener('click', () => {
            loadWordDetails();
            updateUiForState('show_answer');
        });

        btnUnknown.addEventListener('click', () => {
            loadWordDetails();
            updateUiForState('make_sentence');
        });

        btnConfirmKnown.addEventListener('click', () => {
            const wordIndex = allWords.findIndex(w => w.word === currentWord.word);
            allWords[wordIndex].status = 'known';
            allWords[wordIndex].srsLevel = -1;
            saveState();
            showNextWord();
        });

        btnCorrection.addEventListener('click', () => {
            updateUiForState('make_sentence');
        });

        // (å·²æ›´æ–°) æäº¤æŒ‰é’®ç°åœ¨è°ƒç”¨çœŸå®AIå‡½æ•°
        btnSubmitSentence.addEventListener('click', async () => {
            const userSentence = sentenceInputEl.value.trim();
            if (userSentence) {
                // è°ƒç”¨æ–°çš„çœŸå®AIå‡½æ•°
                const feedback = await getRealAiSentenceCheck(currentWord.word, userSentence);
                aiFeedbackEl.innerHTML = feedback;
                updateUiForState('show_feedback');
            } else {
                alert("è¯·è¾“å…¥ä¸€ä¸ªå¥å­ï¼");
            }
        });

        btnFinishLearning.addEventListener('click', () => {
            const wordIndex = allWords.findIndex(w => w.word === currentWord.word);
            allWords[wordIndex].status = 'learning';
            let currentLevel = allWords[wordIndex].srsLevel;
            if (currentLevel < SRS_INTERVALS_DAYS.length - 1) {
                allWords[wordIndex].srsLevel++;
            }
            const interval = SRS_INTERVALS_DAYS[currentLevel];
            const nextReviewDate = new Date();
            nextReviewDate.setDate(nextReviewDate.getDate() + interval);
            allWords[wordIndex].nextReviewDate = nextReviewDate.toISOString();
            
            saveState();
            showNextWord();
        });

        // --- 8. åˆå§‹åŒ–åº”ç”¨ ---
        async function initializeApp() {
             allWords = loadState();
             if (allWords.length === 0) {
                 try {
                     const response = await fetch(WORD_LIST_URL);
                     if (!response.ok) throw new Error('æ— æ³•è·å–äº‘ç«¯è¯åº“');
                     const wordList = await response.json();
                     allWords = wordList.map(word => ({ word: word, status: 'new', srsLevel: 0, nextReviewDate: null }));
                     saveState();
                 } catch (error) {
                     mainWordEl.textContent = `åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
                     return;
                 }
             }
             showNextWord();
        }

        initializeApp();
    </script>
</body>
</html>
