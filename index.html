<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº·åº·èƒŒè¯å™¨</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 1rem; }
        main { text-align: center; width: 100%; max-width: 600px; margin: 0 auto;}

        /* --- æ ·å¼éƒ¨åˆ† --- */
        .hidden { display: none !important; }
        #app-title { font-size: 2.8rem; font-weight: 300; color: #555; letter-spacing: 4px; margin: 1rem 0 2rem 0; }
        
        #add-word-container { display: flex; gap: 10px; margin-bottom: 1.5rem; background-color: #fff; padding: 1rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        #add-word-input { flex-grow: 1; border: 1px solid #ccc; padding: 0.75rem; border-radius: 8px; font-size: 1rem; }
        #add-word-btn { border: none; background-color: #17a2b8; color: white; padding: 0 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s; }
        #add-word-btn:hover { background-color: #138496; }

        .mode-switcher { margin-bottom: 1.5rem; }
        .mode-button { background: #fff; border: 1px solid #ccc; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin: 0 5px; }
        .mode-button.active { background: #007bff; color: white; border-color: #007bff; }

        .review-list-view { display: none; padding: 1rem 1.5rem; background: #fff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: left; max-height: 500px; overflow-y: auto;}
        .review-list-view h3 { text-align: center; margin-top: 0;}
        .review-list-view ul { list-style: none; padding: 0;}
        .review-list-view li { padding: 0.75rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { background-color: #dc3545; color: white; border: none; border-radius: 5px; padding: 0.2rem 0.6rem; font-size: 0.8rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease; }
        .delete-btn:hover { opacity: 1; }

        .word-card { background-color: #ffffff; padding: 2.5rem 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); min-height: 400px; display: flex; flex-direction: column; justify-content: center; }
        .word-header { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
        #main-word { font-size: 3.5rem; font-weight: bold; margin: 0; }
        #word-details { transition: opacity 0.5s ease; }
        #pronunciation, #definition { margin: 0.5rem 0; }
        .speak-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; line-height: 1; border-radius: 50%; transition: background-color 0.2s; }
        .speak-btn:hover { background-color: #f0f0f0; }
        .speak-btn svg { width: 28px; height: 28px; fill: #555; }

        #sentence-maker, #challenge-sentence-maker { margin-top: 1.5rem; }
        #sentence-input, #challenge-sentence-input { width: 100%; min-height: 80px; padding: 0.5rem; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; }
        #ai-feedback, #challenge-ai-feedback { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; background-color: #e9ecef; text-align: left;}

        #loading-spinner, #challenge-loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .actions { margin-top: 2rem; display: flex; justify-content: space-around; }
        .action-button { width: 45%; border: none; padding: 1rem; border-radius: 50px; font-size: 1.2rem; cursor: pointer; transition: all 0.2s ease; }
        #btn-unknown { background-color: #ffc107; }
        #btn-known, #btn-confirm-known { background-color: #28a745; color: white; }
        #btn-correction, #btn-submit-sentence, #btn-finish-learning, #btn-start-challenge, #btn-submit-challenge, #btn-next-challenge { background-color: #007bff; color: white; }
        
        #challenge-setup { padding: 2rem; }
        #challenge-words-display { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 1.5rem; }
        .challenge-word-item { display: flex; align-items: center; gap: 8px; background: #fff; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; }
        .challenge-word-item label { font-size: 0.8rem; cursor: pointer; }
    </style>
</head>
<body>
    
    <main>
        <h1 id="app-title">åº·åº·èƒŒè¯å™¨</h1>
        
        <div id="add-word-container">
            <input type="text" id="add-word-input" placeholder="å‘è¯åº“æ·»åŠ æ–°å•è¯...">
            <button id="add-word-btn">æ·»åŠ å¹¶å­¦ä¹ </button>
        </div>

        <div class="mode-switcher">
            <button id="mode-learn" class="mode-button active">å­¦ä¹ </button>
            <button id="mode-challenge" class="mode-button">é€ å¥å¤§æŒ‘æˆ˜</button>
            <button id="mode-review-known" class="mode-button">å·²è®¤è¯†åˆ—è¡¨</button>
            <button id="mode-review-learning" class="mode-button">å¾…å¤ä¹ åˆ—è¡¨</button>
        </div>

        <!-- å­¦ä¹ è§†å›¾ -->
        <div id="learn-view">
            <div class="word-card">
                <div class="word-header">
                    <h2 id="main-word">æ­£åœ¨åˆå§‹åŒ–...</h2>
                    <button id="speak-btn" class="speak-btn hidden" title="æœ—è¯»å•è¯">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                    </button>
                </div>
                <div id="word-details" class="hidden">
                    <p id="pronunciation"></p>
                    <p id="definition"></p>
                </div>
                <div id="sentence-maker" class="hidden">
                    <p><strong>è¯·å°è¯•ç”¨è¿™ä¸ªå•è¯é€ ä¸€ä¸ªå¥å­ï¼š</strong></p>
                    <textarea id="sentence-input" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„å¥å­..."></textarea>
                </div>
                <div id="loading-spinner" class="hidden"></div>
                <div id="ai-feedback" class="hidden"></div>
            </div>
            <div id="actions-initial" class="actions"> <button id="btn-unknown" class="action-button">ä¸è®¤è¯†</button> <button id="btn-known" class="action-button">è®¤è¯†</button> </div>
            <div id="actions-confirm" class="actions hidden"> <button id="btn-correction" class="action-button">ä¿®æ­£:ä¸è®¤è¯†</button> <button id="btn-confirm-known" class="action-button">ä¸‹ä¸€ä¸ª</button> </div>
            <div id="actions-sentence" class="actions hidden"> <button id="btn-submit-sentence" class="action-button" style="width: 95%;">æäº¤é€ å¥</button> </div>
            <div id="actions-finish" class="actions hidden"> <button id="btn-finish-learning" class="action-button" style="width: 95%;">å®Œæˆå­¦ä¹ </button> </div>
        </div>

        <!-- é€ å¥å¤§æŒ‘æˆ˜è§†å›¾ -->
        <div id="challenge-view" class="hidden">
            <div class="word-card">
                <div id="challenge-setup">
                    <h3>é€ å¥å¤§æŒ‘æˆ˜</h3>
                    <p>é€‰æ‹©å•è¯æ•°é‡ï¼Œç”¨æ‰€æœ‰å‡ºç°çš„å•è¯é€ ä¸€ä¸ªå¥å­æˆ–æ®µè½ã€‚</p>
                    <div>
                        <label for="word-count-selector">å•è¯æ•°é‡: </label>
                        <select id="word-count-selector">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="actions">
                        <button id="btn-start-challenge" class="action-button" style="width: 95%;">å¼€å§‹æŒ‘æˆ˜</button>
                    </div>
                </div>
                <div id="challenge-area" class="hidden">
                    <div id="challenge-words-display"></div>
                    <div id="challenge-sentence-maker">
                        <textarea id="challenge-sentence-input" placeholder="ç”¨ä¸Šé¢çš„æ‰€æœ‰å•è¯é€ å¥..."></textarea>
                    </div>
                    <div id="challenge-loading-spinner" class="hidden"></div>
                    <div id="challenge-ai-feedback" class="hidden"></div>
                </div>
            </div>
            <div id="actions-challenge" class="actions hidden">
                <button id="btn-submit-challenge" class="action-button" style="width: 45%;">æäº¤æ‰¹æ”¹</button>
                <button id="btn-next-challenge" class="action-button" style="width: 45%;">ä¸‹ä¸€ä¸ªæŒ‘æˆ˜</button>
            </div>
        </div>

        <div id="review-known-view" class="review-list-view"> <h3>å·²è®¤è¯†çš„å•è¯</h3> <ul id="known-list"></ul> </div>
        <div id="review-learning-view" class="review-list-view"> <h3>å¾…å¤ä¹ çš„å•è¯</h3> <ul id="learning-list"></ul> </div>
    </main>

    <script>
        // --- 1. é…ç½®å’Œå¸¸é‡ ---
        const WORD_LIST_URL = 'https://gist.githubusercontent.com/Chaos-kjj/fb6947acc8117866d7c62e79b9288f84/raw/b7a1147e0e15df9480cbe5c5e73c8ebc87d981ca/word_lists.json';
        const LOCAL_STORAGE_KEY = 'mySmartWordBook_è€ƒç ”æ ¸å¿ƒ'; // ä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„é”®
        const SRS_INTERVALS_DAYS = [1, 2, 4, 8, 15, 30, 60];
        const NEW_WORDS_PER_SESSION = 5;

        // --- 2. è·å–é¡µé¢å…ƒç´  ---
        const addWordInput = document.getElementById('add-word-input');
        const addWordBtn = document.getElementById('add-word-btn');
        const mainWordEl = document.getElementById('main-word');
        const speakBtn = document.getElementById('speak-btn');
        const learnView = document.getElementById('learn-view');
        const wordDetailsEl = document.getElementById('word-details');
        const pronunciationEl = document.getElementById('pronunciation');
        const definitionEl = document.getElementById('definition');
        const sentenceMakerEl = document.getElementById('sentence-maker');
        const sentenceInputEl = document.getElementById('sentence-input');
        const loadingSpinner = document.getElementById('loading-spinner');
        const aiFeedbackEl = document.getElementById('ai-feedback');
        const actionsInitial = document.getElementById('actions-initial');
        const actionsConfirm = document.getElementById('actions-confirm');
        const actionsSentence = document.getElementById('actions-sentence');
        const actionsFinish = document.getElementById('actions-finish');
        const btnUnknown = document.getElementById('btn-unknown');
        const btnKnown = document.getElementById('btn-known');
        const btnCorrection = document.getElementById('btn-correction');
        const btnConfirmKnown = document.getElementById('btn-confirm-known');
        const btnSubmitSentence = document.getElementById('btn-submit-sentence');
        const btnFinishLearning = document.getElementById('btn-finish-learning');
        const modeLearnBtn = document.getElementById('mode-learn');
        const modeChallengeBtn = document.getElementById('mode-challenge');
        const modeReviewKnownBtn = document.getElementById('mode-review-known');
        const modeReviewLearningBtn = document.getElementById('mode-review-learning');
        const reviewKnownView = document.getElementById('review-known-view');
        const reviewLearningView = document.getElementById('review-learning-view');
        const knownListEl = document.getElementById('known-list');
        const learningListEl = document.getElementById('learning-list');
        const challengeView = document.getElementById('challenge-view');
        const challengeSetup = document.getElementById('challenge-setup');
        const challengeArea = document.getElementById('challenge-area');
        const wordCountSelector = document.getElementById('word-count-selector');
        const btnStartChallenge = document.getElementById('btn-start-challenge');
        const challengeWordsDisplay = document.getElementById('challenge-words-display');
        const challengeSentenceInput = document.getElementById('challenge-sentence-input');
        const challengeLoadingSpinner = document.getElementById('challenge-loading-spinner');
        const challengeAiFeedback = document.getElementById('challenge-ai-feedback');
        const actionsChallenge = document.getElementById('actions-challenge');
        const btnSubmitChallenge = document.getElementById('btn-submit-challenge');
        const btnNextChallenge = document.getElementById('btn-next-challenge');


        // --- 3. çŠ¶æ€ç®¡ç† ---
        let allWords = [];
        let learningQueue = [];
        let currentWord = null;
        let challengeWords = [];

        function loadState() {
            const stateJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
            return stateJSON ? JSON.parse(stateJSON) : [];
        }
        function saveState() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allWords));
        }
        
        // --- 4. UIçŠ¶æ€æœºå’Œè§†å›¾åˆ‡æ¢ ---
        function updateUiForState(state) { /* ...ä¸ä¸Šä¸€ç‰ˆç›¸åŒ... */ wordDetailsEl.classList.add('hidden');sentenceMakerEl.classList.add('hidden');aiFeedbackEl.classList.add('hidden');actionsInitial.classList.add('hidden');actionsConfirm.classList.add('hidden');actionsSentence.classList.add('hidden');actionsFinish.classList.add('hidden');switch (state) {case 'reveal_word':actionsInitial.classList.remove('hidden');break;case 'show_answer':wordDetailsEl.classList.remove('hidden');actionsConfirm.classList.remove('hidden');break;case 'make_sentence':wordDetailsEl.classList.remove('hidden');sentenceMakerEl.classList.remove('hidden');sentenceInputEl.value = '';actionsSentence.classList.remove('hidden');break;case 'show_feedback':wordDetailsEl.classList.remove('hidden');sentenceMakerEl.classList.remove('hidden');aiFeedbackEl.classList.remove('hidden');actionsFinish.classList.remove('hidden');break;}}
        function switchView(mode) {
            learnView.classList.add('hidden');
            challengeView.classList.add('hidden');
            reviewKnownView.classList.add('hidden');
            reviewLearningView.classList.add('hidden');
            
            document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));

            if(mode === 'learn') {
                learnView.classList.remove('hidden');
                modeLearnBtn.classList.add('active');
            } else if (mode === 'challenge') {
                challengeView.classList.remove('hidden');
                modeChallengeBtn.classList.add('active');
            } else if (mode === 'review-known') {
                reviewKnownView.classList.remove('hidden');
                modeReviewKnownBtn.classList.add('active');
                populateReviewList(knownListEl, 'known');
            } else if (mode === 'review-learning') {
                reviewLearningView.classList.remove('hidden');
                modeReviewLearningBtn.classList.add('active');
                populateReviewList(learningListEl, 'learning');
            }
        }
        function populateReviewList(listElement, status) { /* ...ä¸ä¸Šä¸€ç‰ˆç›¸åŒ... */ const words = allWords.filter(w => w.status === status);listElement.innerHTML = '';if (words.length === 0) {listElement.innerHTML = '<li>åˆ—è¡¨ä¸ºç©º</li>';return;}words.sort((a, b) => a.word.localeCompare(b.word));words.forEach(wordObj => {const li = document.createElement('li');const wordSpan = document.createElement('span');let text = wordObj.word;if(status === 'learning' && wordObj.nextReviewDate) {text += ` (ä¸‹æ¬¡å¤ä¹ : ${new Date(wordObj.nextReviewDate).toLocaleDateString()})`;}wordSpan.textContent = text;const deleteBtn = document.createElement('button');deleteBtn.textContent = 'åˆ é™¤';deleteBtn.className = 'delete-btn';deleteBtn.dataset.word = wordObj.word;deleteBtn.addEventListener('click', handleDeleteWord);li.appendChild(wordSpan);li.appendChild(deleteBtn);listElement.appendChild(li);});}

        // --- 5. æ ¸å¿ƒå­¦ä¹ é€»è¾‘ ---
        function speakWord(text) { if ('speechSynthesis' in window && text) { window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'en-US'; utterance.rate = 0.9; window.speechSynthesis.speak(utterance); } }
        function shuffleArray(array) { /* ...ä¸ä¸Šä¸€ç‰ˆç›¸åŒ... */ for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        function buildLearningQueue() { /* ...ä¸ä¸Šä¸€ç‰ˆç›¸åŒ... */ const today = new Date().setHours(0, 0, 0, 0); const wordsToReview = allWords.filter(word => word.status === 'learning' && new Date(word.nextReviewDate).setHours(0,0,0,0) <= today); const newWords = allWords.filter(word => word.status === 'new'); shuffleArray(wordsToReview); shuffleArray(newWords); learningQueue = [...wordsToReview]; if (wordsToReview.length === 0 && newWords.length > 0) { learningQueue = newWords.slice(0, NEW_WORDS_PER_SESSION); } }
        function showNextWord() { buildLearningQueue();if (learningQueue.length > 0) {currentWord = learningQueue.shift();mainWordEl.textContent = currentWord.word;updateUiForState('reveal_word');speakBtn.classList.remove('hidden');} else {learnView.innerHTML = `<div class="word-card" style="font-size: 1.5rem; color: #007bff;">ä»Šæ—¥ä»»åŠ¡å®Œæˆï¼ğŸ‰</div>`;speakBtn.classList.add('hidden');}}
        async function loadWordDetails() { /* ...ä¸ä¸Šä¸€ç‰ˆç›¸åŒ... */ pronunciationEl.textContent = '...';definitionEl.textContent = 'æ­£åœ¨è·å–ä¸­æ–‡é‡Šä¹‰...';try {const response = await fetch('/api/get-definition', {method: 'POST',headers: { 'Content-Type': 'application/json' },body: JSON.stringify({ word: currentWord.word })});if (!response.ok) {const errorData = await response.json();throw new Error(errorData.error || 'è·å–é‡Šä¹‰å¤±è´¥');}const data = await response.json();pronunciationEl.textContent = data.pronunciation || '';definitionEl.textContent = data.definition || 'æ— å¯ç”¨é‡Šä¹‰';} catch (error) {console.error("åŠ è½½å•è¯è¯¦æƒ…å¤±è´¥:", error);definitionEl.textContent = `é‡Šä¹‰åŠ è½½å¤±è´¥: ${error.message}`;}}
        function startNewChallenge() { const wordCount = parseInt(wordCountSelector.value); const availableWords = allWords.filter(w => w.status !== 'known'); if (availableWords.length < wordCount) { alert(`è¯åº“ä¸­å¯ä¾›æŒ‘æˆ˜çš„å•è¯ä¸è¶³${wordCount}ä¸ªï¼`); return; } shuffleArray(availableWords); challengeWords = availableWords.slice(0, wordCount).map(w => w.word); challengeWordsDisplay.innerHTML = ''; challengeWords.forEach(word => { const itemDiv = document.createElement('div'); itemDiv.className = 'challenge-word-item'; const wordSpan = document.createElement('span'); wordSpan.textContent = word; const checkboxLabel = document.createElement('label'); const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.dataset.word = word; checkboxLabel.appendChild(checkbox); checkboxLabel.append(' ä¸è®¤è¯†'); itemDiv.appendChild(wordSpan); itemDiv.appendChild(checkboxLabel); challengeWordsDisplay.appendChild(itemDiv); }); challengeSetup.classList.add('hidden'); challengeArea.classList.remove('hidden'); challengeSentenceInput.value = ''; challengeAiFeedback.classList.add('hidden'); actionsChallenge.classList.remove('hidden'); btnSubmitChallenge.classList.remove('hidden'); btnNextChallenge.classList.add('hidden'); }

        // --- 6. è¿æ¥çœŸå®AI (é€ å¥æ‰¹æ”¹) ---
        async function getRealAiSentenceCheck(words, sentence) {
            try {
                const response = await fetch('/api/check-sentence', {method: 'POST',headers: {'Content-Type': 'application/json',},body: JSON.stringify({ words, sentence }),});
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`AIæœåŠ¡å™¨è¿”å›é”™è¯¯: ${errorData.error || response.statusText}`);
                }
                const data = await response.json();
                let feedbackHTML = `<p><strong>AIè€å¸ˆç‚¹è¯„ï¼š</strong></p><p>${data.explanation}</p><p><strong>å‚è€ƒä¾‹å¥ï¼š</strong> ${data.correct_example}</p>`;
                return feedbackHTML;
            } catch (error) {
                console.error("è¿æ¥AIå¤±è´¥:", error);
                return `âŒ è¿æ¥AIæ—¶å‡ºé”™ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚<br>é”™è¯¯è¯¦æƒ…: ${error.message}`;
            }
        }

        // --- 7. äº‹ä»¶å¤„ç† ---
        function handleDeleteWord(event) { /* ...ä¸ä¸Šä¸€ç‰ˆç›¸åŒ... */ const wordToDelete = event.target.dataset.word;if (wordToDelete && confirm(`ç¡®å®šè¦ä»è¯åº“ä¸­æ°¸ä¹…åˆ é™¤å•è¯ "${wordToDelete}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {const wordIndex = allWords.findIndex(w => w.word === wordToDelete);if (wordIndex > -1) {allWords.splice(wordIndex, 1);saveState();const currentView = document.querySelector('.mode-button.active').id;if (currentView === 'mode-review-known') {populateReviewList(knownListEl, 'known');} else if (currentView === 'mode-review-learning') {populateReviewList(learningListEl, 'learning');}}}}
        function handleAddWordClick() { /* ...ä¸ä¸Šä¸€ç‰ˆç›¸åŒ... */ const newWordStr = addWordInput.value.trim().toLowerCase();if (!newWordStr) { alert('è¯·è¾“å…¥ä¸€ä¸ªå•è¯ã€‚'); return; } const existingWord = allWords.find(w => w.word === newWordStr);if (existingWord) { alert(`å•è¯ "${newWordStr}" å·²å­˜åœ¨äºæ‚¨çš„è¯åº“ä¸­ï¼ŒçŠ¶æ€ä¸ºï¼š${existingWord.status}ã€‚`); return; }const newWordObj = { word: newWordStr, status: 'new', srsLevel: 0, nextReviewDate: null };allWords.push(newWordObj);saveState();addWordInput.value = ''; alert(`å•è¯ "${newWordStr}" å·²æˆåŠŸæ·»åŠ åˆ°æ‚¨çš„è¯åº“ï¼ç°åœ¨å¼€å§‹å­¦ä¹ å§ã€‚`);currentWord = newWordObj;switchView('learn');mainWordEl.textContent = currentWord.word;speakBtn.classList.remove('hidden');loadWordDetails();updateUiForState('make_sentence'); }
        
        speakBtn.addEventListener('click', () => { if (currentWord) { speakWord(currentWord.word); } });
        addWordBtn.addEventListener('click', handleAddWordClick);
        
        btnKnown.addEventListener('click', () => { loadWordDetails(); updateUiForState('show_answer'); });
        btnUnknown.addEventListener('click', () => { loadWordDetails(); updateUiForState('make_sentence'); });
        btnConfirmKnown.addEventListener('click', () => { const wordIndex = allWords.findIndex(w => w.word === currentWord.word);allWords[wordIndex].status = 'known';allWords[wordIndex].srsLevel = -1;saveState();showNextWord(); });
        btnCorrection.addEventListener('click', () => { updateUiForState('make_sentence'); });
        btnSubmitSentence.addEventListener('click', async () => { const userSentence = sentenceInputEl.value.trim();if (userSentence) {loadingSpinner.classList.remove('hidden');aiFeedbackEl.classList.add('hidden');let feedback = '';try {feedback = await getRealAiSentenceCheck([currentWord.word], userSentence);} catch (e) {feedback = `âŒ è¯·æ±‚AIæ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚`;} finally {loadingSpinner.classList.add('hidden');aiFeedbackEl.innerHTML = feedback;updateUiForState('show_feedback');}} else {alert("è¯·è¾“å…¥ä¸€ä¸ªå¥å­ï¼");} });
        btnFinishLearning.addEventListener('click', () => { const wordIndex = allWords.findIndex(w => w.word === currentWord.word);allWords[wordIndex].status = 'learning';let currentLevel = allWords[wordIndex].srsLevel;if (currentLevel < SRS_INTERVALS_DAYS.length - 1) {allWords[wordIndex].srsLevel++;}const interval = SRS_INTERVALS_DAYS[currentLevel];const nextReviewDate = new Date();nextReviewDate.setDate(nextReviewDate.getDate() + interval);allWords[wordIndex].nextReviewDate = nextReviewDate.toISOString();saveState();showNextWord(); });
        
        btnStartChallenge.addEventListener('click', startNewChallenge);
        btnNextChallenge.addEventListener('click', startNewChallenge);
        btnSubmitChallenge.addEventListener('click', async () => {
            const userSentence = challengeSentenceInput.value.trim();
            if (!userSentence) {
                alert('è¯·è¾“å…¥æ‚¨çš„å¥å­ï¼');
                return;
            }

            const unknownWordsCheckboxes = challengeWordsDisplay.querySelectorAll('input[type="checkbox"]:checked');
            unknownWordsCheckboxes.forEach(checkbox => {
                const wordToMark = checkbox.dataset.word;
                const wordIndex = allWords.findIndex(w => w.word === wordToMark);
                if (wordIndex > -1 && allWords[wordIndex].status !== 'known') {
                    const wordObj = allWords[wordIndex];
                    wordObj.status = 'learning';
                    wordObj.srsLevel = 0;
                    const interval = SRS_INTERVALS_DAYS[wordObj.srsLevel];
                    const nextReviewDate = new Date();
                    nextReviewDate.setDate(nextReviewDate.getDate() + interval);
                    wordObj.nextReviewDate = nextReviewDate.toISOString();
                }
            });
            saveState();

            challengeAiFeedback.classList.add('hidden');
            challengeLoadingSpinner.classList.remove('hidden');
            let feedback = '';
            try {
                feedback = await getRealAiSentenceCheck(challengeWords, userSentence);
            } catch (e) {
                feedback = `âŒ è¯·æ±‚AIæ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚`;
            } finally {
                challengeLoadingSpinner.classList.add('hidden');
                challengeAiFeedback.innerHTML = feedback;
                challengeAiFeedback.classList.remove('hidden');
                btnSubmitChallenge.classList.add('hidden');
                btnNextChallenge.classList.remove('hidden');
            }
        });

        modeLearnBtn.addEventListener('click', () => switchView('learn'));
        modeChallengeBtn.addEventListener('click', () => switchView('challenge'));
        modeReviewKnownBtn.addEventListener('click', () => switchView('review-known'));
        modeReviewLearningBtn.addEventListener('click', () => switchView('review-learning'));

        // --- 8. åˆå§‹åŒ–åº”ç”¨ ---
        async function initializeApp() {
            let loadedData = loadState();
            let migratedWords = [];

            // (å·²ä¿®å¤) æ›´å¥å£®çš„æ•°æ®è¿ç§»å’ŒéªŒè¯é€»è¾‘
            if (loadedData.length > 0) {
                migratedWords = loadedData.map(item => {
                    if (typeof item === 'string') {
                        return { word: item, status: 'new', srsLevel: 0, nextReviewDate: null };
                    }
                    if (typeof item === 'object' && item !== null && item.word) {
                        return {
                            word: item.word,
                            status: item.status || 'new',
                            srsLevel: item.srsLevel !== undefined ? item.srsLevel : 0,
                            nextReviewDate: item.nextReviewDate || null
                        };
                    }
                    return null;
                }).filter(Boolean);
            }

            allWords = migratedWords;

            if (allWords.length === 0) {
                 try {
                     const response = await fetch(WORD_LIST_URL);
                     if (!response.ok) throw new Error('æ— æ³•è·å–äº‘ç«¯è¯åº“');
                     const wordList = await response.json();
                     let initialWords = [];
                     if (Array.isArray(wordList)) {
                        initialWords = wordList;
                     } else {
                        const firstListName = Object.keys(wordList)[0];
                        if (firstListName) {
                            initialWords = wordList[firstListName];
                        } else {
                            throw new Error('äº‘ç«¯è¯åº“æ ¼å¼ä¸æ­£ç¡®');
                        }
                     }
                     allWords = initialWords.map(word => ({ word: word, status: 'new', srsLevel: 0, nextReviewDate: null }));
                 } catch (error) {
                     learnView.innerHTML = `<div class="word-card">åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
                     return;
                 }
            }
            
            saveState();
            switchView('learn');
            showNextWord();
        }

        initializeApp();
    </script>
</body>
</html>