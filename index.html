<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>康康背词器</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 1rem; }
        main { text-align: center; width: 100%; max-width: 600px; margin: 0 auto;}

        /* --- 样式部分 --- */
        .hidden { display: none !important; }
        #app-title { font-size: 2.8rem; font-weight: 300; color: #555; letter-spacing: 4px; margin: 1rem 0 2rem 0; }
        
        #add-word-container { display: flex; gap: 10px; margin-bottom: 1.5rem; background-color: #fff; padding: 1rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        #add-word-input { flex-grow: 1; border: 1px solid #ccc; padding: 0.75rem; border-radius: 8px; font-size: 1rem; }
        #add-word-btn { border: none; background-color: #17a2b8; color: white; padding: 0 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s; }
        #add-word-btn:hover { background-color: #138496; }

        .mode-switcher { margin-bottom: 1.5rem; }
        .mode-button { background: #fff; border: 1px solid #ccc; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin: 0 5px; }
        .mode-button.active { background: #007bff; color: white; border-color: #007bff; }

        .review-list-view { display: none; padding: 1rem 1.5rem; background: #fff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: left; max-height: 500px; overflow-y: auto;}
        .review-list-view h3 { text-align: center; margin-top: 0;}
        .review-list-view ul { list-style: none; padding: 0;}
        .review-list-view li { padding: 0.75rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { background-color: #dc3545; color: white; border: none; border-radius: 5px; padding: 0.2rem 0.6rem; font-size: 0.8rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease; }
        .delete-btn:hover { opacity: 1; }

        .word-card { background-color: #ffffff; padding: 2.5rem 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); min-height: 400px; display: flex; flex-direction: column; justify-content: center; }
        .word-header { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
        #main-word { font-size: 3.5rem; font-weight: bold; margin: 0; }
        #word-details { transition: opacity 0.5s ease; }
        #pronunciation, #definition { margin: 0.5rem 0; }
        .speak-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; line-height: 1; border-radius: 50%; transition: background-color 0.2s; }
        .speak-btn:hover { background-color: #f0f0f0; }
        .speak-btn svg { width: 28px; height: 28px; fill: #555; }

        #sentence-maker, #challenge-sentence-maker, #translation-challenge-maker { margin-top: 1.5rem; }
        #sentence-input, #challenge-sentence-input, #translation-challenge-input { width: 100%; min-height: 100px; padding: 0.5rem; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; }
        #ai-feedback, #challenge-ai-feedback, #translation-ai-feedback { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; background-color: #e9ecef; text-align: left;}

        #loading-spinner, #challenge-loading-spinner, #translation-loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .actions { margin-top: 2rem; display: flex; justify-content: space-around; }
        .action-button { width: 45%; border: none; padding: 1rem; border-radius: 50px; font-size: 1.2rem; cursor: pointer; transition: all 0.2s ease; }
        #btn-unknown { background-color: #ffc107; }
        #btn-known, #btn-confirm-known { background-color: #28a745; color: white; }
        #btn-correction, #btn-submit-sentence, #btn-finish-learning, #btn-start-challenge, #btn-submit-challenge, #btn-next-challenge, #btn-start-translation-challenge, #btn-submit-translation, #btn-next-translation-challenge { background-color: #007bff; color: white; }
        
        #challenge-setup, #translation-challenge-setup { padding: 2rem; }
        #challenge-words-display { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 1.5rem; }
        .challenge-word-item { display: flex; align-items: center; gap: 8px; background: #fff; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; }
        .challenge-word-item label { font-size: 0.8rem; cursor: pointer; }

        /* (新增) 翻译挑战样式 */
        #translation-chinese-sentence {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 2rem;
            padding: 1rem;
            border-left: 4px solid #28a745;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    
    <main>
        <h1 id="app-title">康康背词器</h1>
        <div id="add-word-container">
            <input type="text" id="add-word-input" placeholder="向词库添加新单词...">
            <button id="add-word-btn">添加并学习</button>
        </div>
        <div class="mode-switcher">
            <button id="mode-learn" class="mode-button active">学习</button>
            <button id="mode-challenge" class="mode-button">造句大挑战</button>
            <button id="mode-translation-challenge" class="mode-button">翻译大挑战 ✍️</button>
            <button id="mode-review-known" class="mode-button">已认识列表</button>
            <button id="mode-review-learning" class="mode-button">待复习列表</button>
        </div>

        <!-- 学习视图 -->
        <div id="learn-view">
            <!-- ... 此处内容保持不变 ... -->
        </div>

        <!-- 造句大挑战视图 -->
        <div id="challenge-view" class="hidden">
            <!-- ... 此处内容保持不变 ... -->
        </div>

        <!-- (新增) 翻译大挑战视图 -->
        <div id="translation-challenge-view" class="hidden">
            <div class="word-card">
                <div id="translation-challenge-setup">
                    <h3>翻译大挑战 ✍️</h3>
                    <p>输入一个中文主题，AI将为您生成一个相关的句子，请将它翻译成英文。</p>
                    <input type="text" id="translation-topic-input" placeholder="例如：散步在雨后" style="width: 100%; padding: 0.5rem; font-size: 1rem; margin-bottom: 1rem;">
                    <div class="actions">
                        <button id="btn-start-translation-challenge" class="action-button" style="width: 95%;">开始挑战</button>
                    </div>
                </div>
                <div id="translation-challenge-area" class="hidden">
                    <p id="translation-chinese-sentence"></p>
                    <div id="translation-challenge-maker">
                        <textarea id="translation-challenge-input" placeholder="在这里输入您的英文翻译..."></textarea>
                    </div>
                    <div id="translation-loading-spinner" class="hidden"></div>
                    <div id="translation-ai-feedback" class="hidden"></div>
                </div>
            </div>
            <div id="actions-translation-challenge" class="actions hidden">
                <button id="btn-submit-translation" class="action-button" style="width: 45%;">提交批改</button>
                <button id="btn-next-translation-challenge" class="action-button" style="width: 45%;">下一个题目</button>
            </div>
        </div>

        <div id="review-known-view" class="review-list-view"> <h3>已认识的单词</h3> <ul id="known-list"></ul> </div>
        <div id="review-learning-view" class="review-list-view"> <h3>待复习的单词</h3> <ul id="learning-list"></ul> </div>
    </main>

    <script>
        // --- 1. 配置和常量 ---
        // ... (常量保持不变) ...

        // --- 2. 获取页面元素 ---
        // ... (其他元素获取保持不变) ...
        const modeTranslationChallengeBtn = document.getElementById('mode-translation-challenge');
        const translationChallengeView = document.getElementById('translation-challenge-view');
        const translationChallengeSetup = document.getElementById('translation-challenge-setup');
        const translationTopicInput = document.getElementById('translation-topic-input');
        const btnStartTranslationChallenge = document.getElementById('btn-start-translation-challenge');
        const translationChallengeArea = document.getElementById('translation-challenge-area');
        const translationChineseSentenceEl = document.getElementById('translation-chinese-sentence');
        const translationChallengeInput = document.getElementById('translation-challenge-input');
        const translationLoadingSpinner = document.getElementById('translation-loading-spinner');
        const translationAiFeedback = document.getElementById('translation-ai-feedback');
        const actionsTranslationChallenge = document.getElementById('actions-translation-challenge');
        const btnSubmitTranslation = document.getElementById('btn-submit-translation');
        const btnNextTranslationChallenge = document.getElementById('btn-next-translation-challenge');

        // --- 3. 状态管理 ---
        let allWords = [];
        let learningQueue = [];
        let currentWord = null;
        let challengeWords = [];
        let currentChineseSentence = ''; // (新增)

        // ... (loadState, saveState 保持不变) ...
        
        // --- 4. UI状态机和视图切换 ---
        function switchView(mode) {
            learnView.classList.add('hidden');
            challengeView.classList.add('hidden');
            translationChallengeView.classList.add('hidden');
            reviewKnownView.classList.add('hidden');
            reviewLearningView.classList.add('hidden');
            
            document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));

            if(mode === 'learn') {
                learnView.classList.remove('hidden');
                modeLearnBtn.classList.add('active');
            } else if (mode === 'challenge') {
                challengeView.classList.remove('hidden');
                modeChallengeBtn.classList.add('active');
            } else if (mode === 'translation-challenge') {
                translationChallengeView.classList.remove('hidden');
                modeTranslationChallengeBtn.classList.add('active');
            } else if (mode === 'review-known') {
                reviewKnownView.classList.remove('hidden');
                modeReviewKnownBtn.classList.add('active');
                populateReviewList(knownListEl, 'known');
            } else if (mode === 'review-learning') {
                reviewLearningView.classList.remove('hidden');
                modeReviewLearningBtn.classList.add('active');
                populateReviewList(learningListEl, 'learning');
            }
        }
        // ... (其他UI函数保持不变) ...

        // --- 5. 核心学习逻辑 ---
        // ... (大部分函数保持不变) ...

        // (新增) 开始一次新的翻译挑战
        async function startNewTranslationChallenge() {
            const topic = translationTopicInput.value.trim();
            if (!topic) {
                alert('请输入一个中文主题！');
                return;
            }

            translationChallengeSetup.classList.add('hidden');
            translationChallengeArea.classList.remove('hidden');
            translationAiFeedback.classList.add('hidden');
            actionsTranslationChallenge.classList.remove('hidden');
            btnSubmitTranslation.classList.remove('hidden');
            btnNextTranslationChallenge.classList.add('hidden');
            translationChallengeInput.value = '';
            translationLoadingSpinner.classList.remove('hidden');
            translationChineseSentenceEl.textContent = 'AI 正在为您生成中文句子...';

            try {
                const response = await fetch('/api/get-translation-challenge', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });
                if (!response.ok) throw new Error('获取中文句子失败');
                
                const data = await response.json();
                currentChineseSentence = data.chinese_sentence;
                translationChineseSentenceEl.textContent = currentChineseSentence;

            } catch (error) {
                translationChineseSentenceEl.textContent = `❌ 获取句子失败: ${error.message}`;
            } finally {
                translationLoadingSpinner.classList.add('hidden');
            }
        }

        // --- 6. 连接真实AI ---
        // ... (getRealAiSentenceCheck 保持不变) ...

        // (新增) 调用AI批改翻译
        async function getRealAiTranslationCheck(original, translation) {
            try {
                const response = await fetch('/api/check-translation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ original_chinese: original, user_translation: translation })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`AI服务器返回错误: ${errorData.error || response.statusText}`);
                }
                const data = await response.json();
                let feedbackHTML = `<p><strong>AI老师点评：</strong></p><p>${data.explanation}</p><p><strong>参考翻译：</strong> ${data.better_translation}</p>`;
                return feedbackHTML;
            } catch (error) {
                console.error("连接翻译批改AI失败:", error);
                return `❌ 请求AI批改时出错。<br>错误详情: ${error.message}`;
            }
        }

        // --- 7. 事件处理 ---
        // ... (大部分事件处理保持不变) ...

        // (新增) 翻译挑战模式事件处理
        btnStartTranslationChallenge.addEventListener('click', startNewTranslationChallenge);
        btnNextTranslationChallenge.addEventListener('click', () => {
            translationChallengeSetup.classList.remove('hidden');
            translationChallengeArea.classList.add('hidden');
            actionsTranslationChallenge.classList.add('hidden');
        });
        btnSubmitTranslation.addEventListener('click', async () => {
            const userTranslation = translationChallengeInput.value.trim();
            if (!userTranslation) {
                alert('请输入您的翻译！');
                return;
            }
            
            translationAiFeedback.classList.add('hidden');
            translationLoadingSpinner.classList.remove('hidden');
            let feedback = '';
            try {
                feedback = await getRealAiTranslationCheck(currentChineseSentence, userTranslation);
            } catch (e) {
                feedback = `❌ 请求AI时发生未知错误。`;
            } finally {
                translationLoadingSpinner.classList.add('hidden');
                translationAiFeedback.innerHTML = feedback;
                translationAiFeedback.classList.remove('hidden');
                btnSubmitTranslation.classList.add('hidden');
                btnNextTranslationChallenge.classList.remove('hidden');
            }
        });

        modeTranslationChallengeBtn.addEventListener('click', () => switchView('translation-challenge'));
        // ... (其他模式切换按钮事件处理保持不变) ...

        // --- 8. 初始化应用 ---
        // ... (initializeApp 保持不变) ...
    </script>
</body>
</html>