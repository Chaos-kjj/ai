
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能单词本 - 带删除功能</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 1rem; }
        main { text-align: center; width: 100%; max-width: 600px; margin: 0 auto;}

        /* --- 样式部分 --- */
        .hidden { display: none !important; }

        .mode-switcher { margin-bottom: 1.5rem; }
        .mode-button { background: #fff; border: 1px solid #ccc; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin: 0 5px; }
        .mode-button.active { background: #007bff; color: white; border-color: #007bff; }

        .review-list-view { display: none; padding: 1rem 1.5rem; background: #fff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: left; max-height: 500px; overflow-y: auto;}
        .review-list-view h3 { text-align: center; margin-top: 0;}
        .review-list-view ul { list-style: none; padding: 0;}
        .review-list-view li { 
            padding: 0.75rem; 
            border-bottom: 1px solid #eee; 
            display: flex; /* (新增) 使用Flex布局，方便对齐 */
            justify-content: space-between; /* (新增) 两端对齐 */
            align-items: center; /* (新增) 垂直居中 */
        }

        /* (新增) 删除按钮样式 */
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.2rem 0.6rem;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .delete-btn:hover {
            opacity: 1;
        }

        .word-card { background-color: #ffffff; padding: 2.5rem 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); min-height: 400px; display: flex; flex-direction: column; justify-content: center; }
        #word-details { transition: opacity 0.5s ease; }
        #main-word { font-size: 3.5rem; font-weight: bold; margin-bottom: 2rem; }
        #pronunciation, #definition { margin: 0.5rem 0; }
        
        #sentence-maker { margin-top: 1.5rem; }
        #sentence-input { width: 100%; min-height: 80px; padding: 0.5rem; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; }
        #ai-feedback { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; background-color: #e9ecef; text-align: left;}

        .actions { margin-top: 2rem; display: flex; justify-content: space-around; }
        .action-button { width: 45%; border: none; padding: 1rem; border-radius: 50px; font-size: 1.2rem; cursor: pointer; transition: all 0.2s ease; }
        #btn-unknown { background-color: #ffc107; }
        #btn-known, #btn-confirm-known { background-color: #28a745; color: white; }
        #btn-correction, #btn-submit-sentence, #btn-finish-learning { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    
    <main>
        <div class="mode-switcher">
            <button id="mode-learn" class="mode-button active">学习</button>
            <button id="mode-review-known" class="mode-button">已认识列表</button>
            <button id="mode-review-learning" class="mode-button">待复习列表</button>
        </div>

        <div id="learn-view">
            <div class="word-card">
                <h2 id="main-word">正在初始化...</h2>
                <div id="word-details" class="hidden">
                    <p id="pronunciation"></p>
                    <p id="definition"></p>
                </div>
                <div id="sentence-maker" class="hidden">
                    <p><strong>请尝试用这个单词造一个句子：</strong></p>
                    <textarea id="sentence-input" placeholder="在此输入你的句子..."></textarea>
                </div>
                <div id="ai-feedback" class="hidden"></div>
            </div>
            <div id="actions-initial" class="actions">
                <button id="btn-unknown" class="action-button">不认识</button>
                <button id="btn-known" class="action-button">认识</button>
            </div>
            <div id="actions-confirm" class="actions hidden">
                <button id="btn-correction" class="action-button">修正:不认识</button>
                <button id="btn-confirm-known" class="action-button">下一个</button>
            </div>
            <div id="actions-sentence" class="actions hidden">
                <button id="btn-submit-sentence" class="action-button" style="width: 95%;">提交造句</button>
            </div>
            <div id="actions-finish" class="actions hidden">
                <button id="btn-finish-learning" class="action-button" style="width: 95%;">完成学习</button>
            </div>
        </div>

        <div id="review-known-view" class="review-list-view">
            <h3>已认识的单词</h3>
            <ul id="known-list"></ul>
        </div>

        <div id="review-learning-view" class="review-list-view">
            <h3>待复习的单词</h3>
            <ul id="learning-list"></ul>
        </div>
    </main>

    <script>
        // --- 1. 配置和常量 ---
        const WORD_LIST_URL = 'https://gist.githubusercontent.com/Chaos-kjj/fb6947acc8117866d7c62e79b9288f84/raw/b7a1147e0e15df9480cbe5c5e73c8ebc87d981ca/word_lists.json';
        const LOCAL_STORAGE_KEY = 'mySmartWordBook';
        const SRS_INTERVALS_DAYS = [1, 2, 4, 8, 15, 30, 60];
        const NEW_WORDS_PER_SESSION = 5;

        // --- 2. 获取页面元素 ---
        const learnView = document.getElementById('learn-view');
        const mainWordEl = document.getElementById('main-word');
        const wordDetailsEl = document.getElementById('word-details');
        const pronunciationEl = document.getElementById('pronunciation');
        const definitionEl = document.getElementById('definition');
        const sentenceMakerEl = document.getElementById('sentence-maker');
        const sentenceInputEl = document.getElementById('sentence-input');
        const aiFeedbackEl = document.getElementById('ai-feedback');
        const actionsInitial = document.getElementById('actions-initial');
        const actionsConfirm = document.getElementById('actions-confirm');
        const actionsSentence = document.getElementById('actions-sentence');
        const actionsFinish = document.getElementById('actions-finish');
        const btnUnknown = document.getElementById('btn-unknown');
        const btnKnown = document.getElementById('btn-known');
        const btnCorrection = document.getElementById('btn-correction');
        const btnConfirmKnown = document.getElementById('btn-confirm-known');
        const btnSubmitSentence = document.getElementById('btn-submit-sentence');
        const btnFinishLearning = document.getElementById('btn-finish-learning');
        const modeLearnBtn = document.getElementById('mode-learn');
        const modeReviewKnownBtn = document.getElementById('mode-review-known');
        const modeReviewLearningBtn = document.getElementById('mode-review-learning');
        const reviewKnownView = document.getElementById('review-known-view');
        const reviewLearningView = document.getElementById('review-learning-view');
        const knownListEl = document.getElementById('known-list');
        const learningListEl = document.getElementById('learning-list');

        // --- 3. 状态管理 ---
        let allWords = [];
        let learningQueue = [];
        let currentWord = null;

        function loadState() { return localStorage.getItem(LOCAL_STORAGE_KEY) ? JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) : []; }
        function saveState() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allWords)); }
        
        // --- 4. UI状态机和视图切换 ---
        function updateUiForState(state) { /* ...与上一版相同... */ wordDetailsEl.classList.add('hidden');sentenceMakerEl.classList.add('hidden');aiFeedbackEl.classList.add('hidden');actionsInitial.classList.add('hidden');actionsConfirm.classList.add('hidden');actionsSentence.classList.add('hidden');actionsFinish.classList.add('hidden');switch (state) {case 'reveal_word':actionsInitial.classList.remove('hidden');break;case 'show_answer':wordDetailsEl.classList.remove('hidden');actionsConfirm.classList.remove('hidden');break;case 'make_sentence':wordDetailsEl.classList.remove('hidden');sentenceMakerEl.classList.remove('hidden');sentenceInputEl.value = '';actionsSentence.classList.remove('hidden');break;case 'show_feedback':wordDetailsEl.classList.remove('hidden');sentenceMakerEl.classList.remove('hidden');aiFeedbackEl.classList.remove('hidden');actionsFinish.classList.remove('hidden');break;}}
        function switchView(mode) { /* ...与上一版相同... */ learnView.style.display = 'none';reviewKnownView.style.display = 'none';reviewLearningView.style.display = 'none';modeLearnBtn.classList.remove('active');modeReviewKnownBtn.classList.remove('active');modeReviewLearningBtn.classList.remove('active');if(mode === 'learn') {learnView.style.display = 'block';modeLearnBtn.classList.add('active');} else if (mode === 'review-known') {reviewKnownView.style.display = 'block';modeReviewKnownBtn.classList.add('active');populateReviewList(knownListEl, 'known');} else if (mode === 'review-learning') {reviewLearningView.style.display = 'block';modeReviewLearningBtn.classList.add('active');populateReviewList(learningListEl, 'learning');}}
        
        /**
         * (已更新) 填充回顾列表，并添加删除按钮
         * @param {HTMLElement} listElement - 要填充的<ul>元素
         * @param {string} status - 要显示的单词状态 ('known' 或 'learning')
         */
        function populateReviewList(listElement, status) {
            const words = allWords.filter(w => w.status === status);
            listElement.innerHTML = '';
            if (words.length === 0) {
                listElement.innerHTML = '<li>列表为空</li>';
                return;
            }
            words.sort((a, b) => a.word.localeCompare(b.word));
            words.forEach(wordObj => {
                const li = document.createElement('li');
                
                const wordSpan = document.createElement('span');
                let text = wordObj.word;
                if(status === 'learning' && wordObj.nextReviewDate) {
                    text += ` (下次复习: ${new Date(wordObj.nextReviewDate).toLocaleDateString()})`;
                }
                wordSpan.textContent = text;
                
                // (新增) 创建删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '删除';
                deleteBtn.className = 'delete-btn';
                deleteBtn.dataset.word = wordObj.word; // 将单词存入data属性，方便获取
                deleteBtn.addEventListener('click', handleDeleteWord); // 绑定点击事件

                li.appendChild(wordSpan);
                li.appendChild(deleteBtn);
                listElement.appendChild(li);
            });
        }

        // --- 5. 核心学习逻辑 ---
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        function buildLearningQueue() { const today = new Date().setHours(0, 0, 0, 0); const wordsToReview = allWords.filter(word => word.status === 'learning' && new Date(word.nextReviewDate).setHours(0,0,0,0) <= today); const newWords = allWords.filter(word => word.status === 'new'); shuffleArray(wordsToReview); shuffleArray(newWords); learningQueue = [...wordsToReview]; if (wordsToReview.length === 0 && newWords.length > 0) { learningQueue = newWords.slice(0, NEW_WORDS_PER_SESSION); } }
        function showNextWord() { buildLearningQueue();if (learningQueue.length > 0) {currentWord = learningQueue.shift();mainWordEl.textContent = currentWord.word;updateUiForState('reveal_word');} else {learnView.innerHTML = `<div class="word-card" style="font-size: 1.5rem; color: #007bff;">今日任务完成！🎉</div>`;}}
        async function loadWordDetails() { /* ...与上一版相同... */ pronunciationEl.textContent = '...';definitionEl.textContent = '正在获取中文释义...';try {const response = await fetch('/api/get-definition', {method: 'POST',headers: { 'Content-Type': 'application/json' },body: JSON.stringify({ word: currentWord.word })});if (!response.ok) {const errorData = await response.json();throw new Error(errorData.error || '获取释义失败');}const data = await response.json();pronunciationEl.textContent = data.pronunciation || '';definitionEl.textContent = data.definition || '无可用释义';} catch (error) {console.error("加载单词详情失败:", error);definitionEl.textContent = `释义加载失败: ${error.message}`;}}

        // --- 6. 连接真实AI (造句批改) ---
        async function getRealAiSentenceCheck(word, sentence) { /* ...与上一版相同... */ aiFeedbackEl.innerHTML = "<em>AI 老师正在批改... (这可能需要几秒钟)</em>";try {const response = await fetch('/api/check-sentence', {method: 'POST',headers: {'Content-Type': 'application/json',},body: JSON.stringify({ word, sentence }),});if (!response.ok) {const errorData = await response.json();throw new Error(`AI服务器返回错误: ${errorData.error || response.statusText}`);}const data = await response.json();let feedbackHTML = `<p><strong>AI老师点评：</strong></p><p>${data.explanation}</p><p><strong>参考例句：</strong> ${data.correct_example}</p>`;return feedbackHTML;} catch (error) {console.error("连接AI失败:", error);return `❌ 连接AI时出错。请检查网络或稍后再试。<br>错误详情: ${error.message}`;}}

        // --- 7. 事件处理 ---

        /**
         * (新增) 处理删除按钮的点击事件
         */
        function handleDeleteWord(event) {
            const wordToDelete = event.target.dataset.word;
            if (wordToDelete && confirm(`确定要从词库中永久删除单词 "${wordToDelete}" 吗？此操作不可撤销。`)) {
                const wordIndex = allWords.findIndex(w => w.word === wordToDelete);
                if (wordIndex > -1) {
                    allWords.splice(wordIndex, 1); // 从主数组中移除
                    saveState(); // 保存状态
                    
                    // 刷新当前所在的列表视图
                    const currentView = document.querySelector('.mode-button.active').id;
                    if (currentView === 'mode-review-known') {
                        populateReviewList(knownListEl, 'known');
                    } else if (currentView === 'mode-review-learning') {
                        populateReviewList(learningListEl, 'learning');
                    }
                }
            }
        }

        btnKnown.addEventListener('click', () => { loadWordDetails(); updateUiForState('show_answer'); });
        btnUnknown.addEventListener('click', () => { loadWordDetails(); updateUiForState('make_sentence'); });
        btnConfirmKnown.addEventListener('click', () => { const wordIndex = allWords.findIndex(w => w.word === currentWord.word);allWords[wordIndex].status = 'known';allWords[wordIndex].srsLevel = -1;saveState();showNextWord(); });
        btnCorrection.addEventListener('click', () => { updateUiForState('make_sentence'); });
        btnSubmitSentence.addEventListener('click', async () => { const userSentence = sentenceInputEl.value.trim();if (userSentence) {const feedback = await getRealAiSentenceCheck(currentWord.word, userSentence);aiFeedbackEl.innerHTML = feedback;updateUiForState('show_feedback');} else {alert("请输入一个句子！");} });
        btnFinishLearning.addEventListener('click', () => { const wordIndex = allWords.findIndex(w => w.word === currentWord.word);allWords[wordIndex].status = 'learning';let currentLevel = allWords[wordIndex].srsLevel;if (currentLevel < SRS_INTERVALS_DAYS.length - 1) {allWords[wordIndex].srsLevel++;}const interval = SRS_INTERVALS_DAYS[currentLevel];const nextReviewDate = new Date();nextReviewDate.setDate(nextReviewDate.getDate() + interval);allWords[wordIndex].nextReviewDate = nextReviewDate.toISOString();saveState();showNextWord(); });
        modeLearnBtn.addEventListener('click', () => switchView('learn'));
        modeReviewKnownBtn.addEventListener('click', () => switchView('review-known'));
        modeReviewLearningBtn.addEventListener('click', () => switchView('review-learning'));

        // --- 8. 初始化应用 ---
        async function initializeApp() {
             allWords = loadState();
             if (allWords.length === 0) {
                 try {
                     const response = await fetch(WORD_LIST_URL);
                     if (!response.ok) throw new Error('无法获取云端词库');
                     const wordList = await response.json();
                     allWords = wordList.map(word => ({ word: word, status: 'new', srsLevel: 0, nextReviewDate: null }));
                     saveState();
                 } catch (error) {
                     learnView.innerHTML = `<div class="word-card">初始化失败: ${error.message}</div>`;
                     return;
                 }
             }
             switchView('learn');
             showNextWord();
        }

        initializeApp();
    </script>
</body>
</html>

